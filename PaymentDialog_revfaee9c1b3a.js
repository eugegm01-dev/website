define(["jquery","client-server","base/view","util/promise","util/helpers","popup"],function(a,b,c,d,e,f){"use strict";var g={main:"b-payment-dialog",tabs:"b-payment-dialog__tabs",tabItem:"b-payment-dialog__tabs-item"},h=a("body"),i=h.hasClass("m-pw-checkout-enabled-balance"),j=h.hasClass("payment-midas-enabled"),k=h.hasClass("show-only-canvas"),l=h.hasClass("payment-dialog-debug-enabled"),m="/cgi-bin/app/paymentm?addbalance=1&mna="+b.magic().mna+"&mnb="+b.magic().mnb;i&&(g.main+=" b-popup-2020 m-pw-checkout");var n=c.extend({autoInit:!0,props:{css:["payment"],defaultOptions:{name:"payment-dialog",url:m,width:i?j?520:784:605,height:565}},public:{init:function(b){var c=a("[data-payment-dialog-options]"),f=e.parseJsonFromSrc(c);return this.options=e.extend({},f,this.options||{},b),this.beforeOpen(),new d(function(a,c){this.$iframe=this.getPaymentIframe(b&&b.url),this.showPopup(),this.resolve=a,this.paymentResult=!1,this.bindEvents()}.bind(this))},destroy:function(){this.close(),this.unbindEvents(),this.resolve&&(this.resolve(this.paymentResult),delete this.paymentResult,delete this.resolve),this.popup&&(this.popup.destroy(),delete this.popup),n.__super__.destroy.call(this)},setTabs:function(b){var c=this;"string"===a.type(b)&&(b=JSON.parse(b)),this.tabsCreated||this.createTabs(),this.$tabs.empty(),b.forEach(function(b){a("<div></div>").addClass(g.tabItem).attr("data-tab-id",b.id).html(b.title).appendTo(c.$tabs).on("click",c.onTabItemClick.bind(c))})},resize:function(b){if(a.isPlainObject(b)){var c=this.popup.$el.find(".b-popup__header").first().outerHeight();this.$iframe.css({width:b.width,height:b.height}),this.popup.setSize({height:b.height+c,width:b.width})}},showPopup:function(){var b=this.$iframe,c=this.options&&this.options.locales||{},d=b.attr("src"),e=/((showsuccess=)|(showfail=))/.test(d),h=this.isAddBalanceIframeSrc(d),i=h?c.titleBalance:c.titleBuyItem||"";a(window.document).trigger("popup.forceHide"),this.popup?(this.popup.show(),this.resize(),this.popup.setHeader(i),this.popup.rendered(function(){this.popup.hideInsidePreloader(),this.isPopupHidden=!1}.bind(this))):(this.popup=f.create({rootCssClass:g.main,header:i,width:this.options&&this.options.width||void 0,isShowInsidePreloader:!0,isModal:!0,hideCallback:this.onPopupHideHandler.bind(this),isShowFooter:!1}),this.popup.rendered(function(){this.popup.setContent(b),this.resize(),this.isPopupHidden=!1}.bind(this))),e||(h?n.setPaymentTypeInSession(n.SESSION_KEY_PURCHASE_TYPE_TOP_UP):n.setPaymentTypeInSession(n.SESSION_KEY_PURCHASE_TYPE_BUY))},updatePaymentIframe:function(b){var c=this.getAdaptedIframeSrc(b),d=a.proxy(function(){l&&console.log("[payment dialog] [test] dialog updatePaymentIframe",c,this.$iframe.get()),this.resize(),this.$iframe.off("load",d)},this);this.$iframe.attr("src",c).on("load",d),this.resize(),this.paymentResult=!0}},protected:{onMessage:function(a){if(a.origin!==location.origin)return!1;var b;try{b=JSON.parse(a.data)}catch(a){b={}}b&&b.name&&this[b.name](b.data)},close:function(){this.beforeClose(),this.isPopupHidden=!0,this.popup.hide()},onPopupHideHandler:function(){this.isPopupHidden||this.close()},getAdaptedIframeSrc:function(a){var b=this.isAddBalanceIframeSrc(a),c=a.replace(/\*/g,"%2A")+"&hide_close=1";return i&&(c+="&hide_header=1",b&&(c+="&topup=100")),k&&(c+="&embed=1"),c},getPaymentIframe:function(b){var c,d=this,e=this.options||{},f={height:e.height,style:"visibility: hidden;",width:e.width,src:this.getAdaptedIframeSrc(b||e.url||""),on:{load:function(){d.$iframe.css({visibility:"visible"}),d.popup&&d.popup.hideInsidePreloader()}}};return c=a("<iframe></iframe>",f),c.attr("id","purchase-iframe"),c},isAddBalanceIframeSrc:function(a){return a.indexOf("addbalance=1")>-1||!1},beforeOpen:function(){this.options&&this.options.beforeOpen&&e.isFunction(this.options.beforeOpen)&&this.options.beforeOpen(),a(document).trigger(n.BEFORE_OPEN_EVENT)},beforeClose:function(){this.options&&this.options.beforeClose&&e.isFunction(this.options.beforeClose)&&this.options.beforeClose(),n.cleanPaymentSession(),a(document).trigger(n.BEFORE_CLOSE_EVENT,[{isPaymentDialogDebugEnabled:l,type:this.options&&this.options.type||null,reloadPageAfterClosePopup:this.options&&this.options.reloadPageAfterClosePopup||null}])},createTabs:function(){this.$tabs=a("<div></div>").addClass(g.tabs).appendTo(this.popup.getElement()),this.tabsCreated=!0},bindEvents:function(){this.handlers={onMessage:this.onMessage.bind(this)},window.addEventListener?addEventListener("message",this.handlers.onMessage,!1):attachEvent("onmessage",this.handlers.onMessage)},unbindEvents:function(){window.removeEventListener?removeEventListener("message",this.handlers.onMessage):detachEvent("onmessage",this.handlers.onMessage)},onTabItemClick:function(b){this.$iframe.get(0).contentWindow.postMessage({name:"setTab",data:{tabId:a(b.target).data("tabId")}},"*")}},static:{OPEN_DIALOG:"payment-dialog.open-dialog",BEFORE_OPEN_EVENT:"payment-dialog.before-open",BEFORE_CLOSE_EVENT:"payment-dialog.before-close",PRODUCT_APP_ID:"625595",SESSION_KEY_PURCHASE_TYPE:"payment-dialog.purchase-type",SESSION_KEY_PURCHASE_TYPE_NULL:"0",SESSION_KEY_PURCHASE_TYPE_TOP_UP:"1",SESSION_KEY_PURCHASE_TYPE_BUY:"2",DEFAULT_URL:m,cleanPaymentSession:function(){window.sessionStorage.removeItem(n.SESSION_KEY_PURCHASE_TYPE)},setPaymentTypeInSession:function(a){window.sessionStorage.setItem(n.SESSION_KEY_PURCHASE_TYPE,a)},getPaymentTypeInSession:function(){window.sessionStorage.getItem(n.SESSION_KEY_PURCHASE_TYPE)},create:function(a){return new n(a)}}});return n});