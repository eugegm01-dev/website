define(["jquery","client-server","base/view","util/promise","util/helpers","popup","./vkPayCounter"],function(a,b,c,d,e,f,g){"use strict";var h=a("body"),i=h.hasClass("m-pw-checkout-enabled-balance");if(!i){var j,k,l="payment-dialog.purchase-type",m={main:"b-payment-dialog",tabs:"b-payment-dialog__tabs",tabItem:"b-payment-dialog__tabs-item"},n=h.hasClass("payment-dialog-debug-enabled"),o="625595",p=function(){window.sessionStorage.removeItem(l)},q=function(a,b){var c=Object.assign({},{url:a},b);n&&console.log("[payment dialog] openDialog",a),j?j.popup.destroyed?j.init(c):j.onPayment(a):(j=new k(c),j.init())},r=function(){j&&j.close()},s=function(a,b){var c=window.mailru,d=b.status,e="/cgi-bin/app/paymentm?",f=b.service_name||"";if("success"===d?e+="showsuccess=1":(e+="showfail=1",p()),e+="&issuer_id="+b.issuer_id+"&service_name="+f.replace(/\*/g,"%2A")+"&hide_close=1",n&&console.log("[payment dialog] onPayment",a,b,e,c),window.winModal&&window.winModal.get("paymentDialog").down(),b.app_id){var h={paymentType:"buy",action:"success"===d?"payment-success":"payment-error"};"success"===d&&((new Image).src="https://gstat.imgsmail.ru/gstat?comet.paySuccess=1&rnd="+Math.random()),c&&c.server?c.app_id===b.app_id&&("success"===d?c.server.events.paymentDialog.onPaymentSuccess({app_id:b.app_id,service_name:b.service_name}):c.server.events.paymentDialog.onPaymentFail(),h.info="app-item; app-id: "+b.app_id+"; service_name: "+b.service_name,q(e)):b.app_id===o&&(f=b.service_name,r(),q(e),f&&(f.toLowerCase().indexOf("стикер")>-1?h.info="sticker":f.toLowerCase().indexOf("vip")>-1&&(h.info="vip"))),i&&g(h)}else q(e);p()};return k=c.extend({props:{css:["payment"],defaultOptions:{name:"payment-dialog",url:"/cgi-bin/app/paymentm?addbalance=1&mna="+b.magic().mna+"&mnb="+b.magic().mnb,width:i?784:605,height:565}},public:{init:function(b){var c=a("[data-payment-dialog-options]"),f=e.parseJsonFromSrc(c);return this.options=e.extend({},f,this.options||{},b),this.beforeOpen(),new d(function(a,c){this.renderDialog(b&&b.url),this.resolve=a,this.paymentResult=!1}.bind(this))},renderDialog:function(b){var c,d,e=this,h=this.options||{},j=h.locales||{},k=h.url,n=b||k.replace(/\*/g,"%2A")+"&hide_close=1",o=/((showsuccess=)|(showfail=))/.test(n),p=n.indexOf("addbalance=1")>-1||!1;o||(p?window.sessionStorage.setItem(l,"1"):window.sessionStorage.setItem(l,"2")),i&&(n+="&hide_header=1",p&&(n+="&topup=100")),c={height:this.options.height,src:n,style:"visibility: hidden;",width:this.options.width,on:{load:function(){e.$iframe.css({visibility:"visible"}),e.popup.hideInsidePreloader()}}},this.$iframe=a("<iframe></iframe>",c),this.$iframe.attr("id","purchase-iframe"),d={rootCssClass:m.main,width:this.options.width,isAutoDestroy:!0,isShowInsidePreloader:!0,isModal:!0,hideCallback:this.onPopupHide.bind(this)},i&&(d.isShowFooter=!1,p?(g({action:"open-window",paymentType:"refill"}),d.header=j.titleBalance||""):d.header=j.titleBuyItem||""),this.popup=f.create(d),this.popup.rendered(function(){this.popup.setContent(this.$iframe)}.bind(this)),this.popup.show(),this._bindEvents()},destroy:function(){this.beforeClose(),this._unbindEvents(),this.resolve&&(this.resolve(this.paymentResult),delete this.paymentResult,delete this.resolve)},setTabs:function(b){var c=this;"string"===a.type(b)&&(b=JSON.parse(b)),this._tabsCreated||this._createTabs(),this.$tabs.empty(),b.forEach(function(b){a("<div></div>").addClass(m.tabItem).attr("data-tab-id",b.id).html(b.title).appendTo(c.$tabs).on("click",c._onTabItemClick.bind(c))})},close:function(){this.popup.destroy(),this.destroy(),this.popup.destroyed=!0},resize:function(b){var c;a.isPlainObject(b)&&(c=this.popup.$el.find(".b-popup__header").first().outerHeight(),this.$iframe.css({width:b.width,height:b.height}),this.popup.setSize({height:b.height+c,width:b.width}))}},protected:{beforeOpen:function(){e.isFunction(this.options.beforeOpen)&&this.options.beforeOpen(),a(document).trigger(k.BEFORE_OPEN_EVENT)},beforeClose:function(){this.options&&this.options.beforeClose&&e.isFunction(this.options.beforeClose)&&this.options.beforeClose(),p(),a(document).trigger(k.BEFORE_CLOSE_EVENT,[{isPaymentDialogDebugEnabled:n,type:this.options.type||null,reloadPageAfterClosePopup:this.options&&this.options.reloadPageAfterClosePopup||null}])},_createTabs:function(){this.$tabs=a("<div></div>").addClass(m.tabs).appendTo(this.popup.getElement()),this._tabsCreated=!0},_bindEvents:function(){this._handlers={onMessage:this._onMessage.bind(this)},window.addEventListener?addEventListener("message",this._handlers.onMessage,!1):attachEvent("onmessage",this._handlers.onMessage)},_unbindEvents:function(){window.removeEventListener?removeEventListener("message",this._handlers.onMessage):detachEvent("onmessage",this._handlers.onMessage)},onPopupHide:function(){this.destroy()},onPayment:function(b){n&&console.log("[payment dialog] dialog onPayment",b,this.$iframe.get()),this.$iframe.attr("src",b).load(a.proxy(function(){this.resize()},this)),this.paymentResult=!0},_onMessage:function(a){var b;try{b=JSON.parse(a.data)}catch(a){b={}}b&&b.name&&this[b.name](b.data)},_onTabItemClick:function(b){this.$iframe.get(0).contentWindow.postMessage({name:"setTab",data:{tabId:a(b.target).data("tabId")}},"*")}},static:{BEFORE_OPEN_EVENT:"payment-dialog.before-open",BEFORE_CLOSE_EVENT:"payment-dialog.before-close",create:function(a){return j=new k(a),j.init()}}}),a(window).on("payment",s),a(window).on("close-payment-dialog",r),window.onCometPayment=function(b,c,d,e){n&&console.log("[payment-dialog] onCometPayment",b,c,d,e),a(window).trigger("payment",{app_id:b,issuer_id:e,service_name:c,status:d})},k}});