define(["jquery","base/view","util/helpers","util/promise","util/css-manager","util/scrollbar-width","popup/fade","popup/button"],function(a,b,c,d,e,f,g,h){"use strict";var i=20,j=b.extend({autoInit:!0,props:{autoRemove:!0,defaultOptions:{width:400,height:"auto",marginTop:20,isAutoShow:!0,isAutoDestroy:!1,isModal:!1,isShowFooter:!0,isShowInsidePreloader:!1,isCentered:!1,shouldAdjustScroll:!1,rootCssClass:null,headerCssClass:null,contentCssClass:null,minHeight:null,minWidth:null,maxWidth:null,closeCssClass:"icon-crumbs_delete-album"},templates:{main:"popup/tmpl/main"},css:["popup"],elements:{header:".b-popup__header",content:".b-popup__content",footer:".b-popup__footer",title:".b-popup__header__title"},events:{"click .b-popup__header__close":"onCloseClick"},vars:{isRunRender:!1},cssClasses:{showFooter:"b-popup_show-footer",footerTextClass:"b-popup__footer-text"}},public:{init:function(){return this.onContentMutation=this.onContentMutation.bind(this),this.initOptions(),this.buttons=[],this.ready(this.onReady.bind(this)),this.fade=new g({isCentered:this.options.isCentered}),this.onFadeClickHandler=this.onFadeClick.bind(this),this.onHidePopup=this.hide.bind(this),this.fade.on("click",this.onFadeClickHandler),this.setModal(this.options.isModal),this.options.isAutoShow&&this.show(),this.onBodyKeyDownHandler=this.onBodyKeyDown.bind(this),a(document.body).on("keydown",this.onBodyKeyDownHandler),a(document).on("popup.forceHide",this.onHidePopup),this},destroy:function(){return this.isVisible()&&this.hide(),this.fade.off("click",this.onFadeClickHandler),this.fade.isVisible()&&this.fade.hide(),a(document.body).off("keydown",this.onBodyKeyDownHandler),a(document).off("popup.forceHide",this.onHidePopup),this.isDestroyed=!0,j.__super__.destroy.call(this),this},show:function(){return this.isRunRender||(this.render(),this.isRunRender=!0),d.all([this.rendered(),this.ready()]).then(function(){this.showFade(),this.$el.addClass("show"),this.fade.setHeight(Number(this.$el.height())+2*Number(this.options.marginTop)),this.options.isShowInsidePreloader&&this.showInsidePreloader(),c.isFunction(this.options.showCallback)&&this.options.showCallback(this),this.trigger("show"),a(window.document).trigger("popup.show")}.bind(this)),c.display.isRetina()?e.require("sprites.all.all2x"):e.require("sprites.all.all"),this},hide:function(b){return b=b||{},this.fade.hide(),this.isDestroyed||(c.isjQueryObject(this.$el)&&this.$el.removeClass("show"),c.isFunction(this.options.hideCallback)&&this.options.hideCallback(this),c.isFunction(b.hideCallback)&&b.hideCallback(this),this.isDestroyed||!this.options.isAutoDestroy||b.isNotAutoDestroy||this.destroy()),this.trigger("hide"),a(window.document).trigger("popup.hide"),this},hideElement:function(){c.isjQueryObject(this.$el)&&this.$el.removeClass("show")},showPreloader:function(){this.fade.showPreloader().show()},hidePreloader:function(){this.fade.hidePreloader()},showFade:function(){return this.options&&this.fade.show({isCentered:this.options.isCentered}),this},showInsidePreloader:function(){this.$el.addClass("load")},hideInsidePreloader:function(){this.$el.removeClass("load")},setSize:function(a){var b,c;return void 0!==a.width&&this.$el.width(a.width),void 0!==a.height&&(this.$el.height(a.height),b=Math.max(parseInt(this.$el.css("margin-top"),10),parseInt(this.$el.css("top"),10),this.options.marginTop||0)||0,c=Math.max(parseInt(this.$el.css("margin-bottom"),10),parseInt(this.$el.css("bottom"),10),this.options.marginBottom||0)||0,this.fade.setHeight(Number(a.height)+Number(b)+Number(c))),this},getContent:function(){return this.$content},setContent:function(a){return this.renderElement(a,this.$content,!0),this.hideInsidePreloader(),this.observeContentMutation(),this},getFooter:function(){return this.$footer},setFooterText:function(a){var b=a.value,c=a.isHidden||!1,d=a.animationSpeed||0,e=this.getFooter(),f=e.find("."+this.cssClasses.footerTextClass);return f.length?f.text(b):e.prepend('<div class="'+this.cssClasses.footerTextClass+'">'+b+"</div>"),d&&f.hide(),c?f.fadeOut(d):"none"===f.css("display")&&f.fadeIn(d),this},toggleFooterTextVisibility:function(a,b){var c=this.getFooter(),d=c.find("."+this.cssClasses.footerTextClass);a?d.fadeIn(b||0):d.fadeOut(b||0)},addContent:function(a){return this.renderElement(a,this.$content),this},removeContent:function(){return c.isjQueryObject(this.$content)&&this.$content.empty(),this},getHeader:function(){return this.$header},setHeader:function(a){return this.renderElement(a,this.$title,!0),this},addButton:function(a){var b=new h(a);return b.getElement().appendTo(this.$footer),this.buttons.push(b),this.$el.addClass(this.cssClasses.showFooter),this},setButtons:function(a){return this.removeButtons(),this.addButtons(a)},addButtons:function(a){return c.isArray(a)?a.forEach(function(a){this.addButton(a)}.bind(this)):this.addButton(a),this},removeButtons:function(){return this.buttons.forEach(function(a){a.destroy()}),this.buttons=[],this.$el.removeClass(this.cssClasses.showFooter),this},getButton:function(a){var b;return this.buttons.forEach(function(c){c.getName()&&c.getName()===a&&(b=c)}),b},setModal:function(a){this.isModalMode=!!a},isModal:function(){return!!this.isModalMode},isVisible:function(){return this.$el&&this.$el.size()&&this.$el.hasClass("show")}},protected:{initOptions:function(){var b;this.constructor.options||(b=a(".b-popup-options"),b.size()&&(this.constructor.options=JSON.parse(b.html()))),this.options=a.extend(!0,{},this.constructor.options,this.options)},observeContentMutation:function(){this.options.shouldAdjustScroll&&(this.contentMutationObserver||(this.contentMutationObserver=new MutationObserver(this.onContentMutation)),this.contentMutationObserver.observe(this.$content[0],{attributes:!0,childList:!0,subtree:!0}))},onContentMutation:function(){var a,b,c=f();0===c?a=i:(b=this.$content[0].scrollHeight>this.$content[0].clientHeight,a=b?i-c:i),this.contentMutationObserver.disconnect(),this.$content.css("paddingRight",a),this.observeContentMutation()},renderElement:function(b,d,e){e&&d&&d.length&&d.empty(),c.isjQueryObject(b)?b.appendTo(d):c.isString(b)?d.append(a("<div>"+b+"</div>")):c.isNode(b)&&a(b).appendTo(d)},onRender:function(){this.$el.appendTo(this.fade.getContainer()),this.setSize({width:this.options.width,height:this.options.height}),this.options.minHeight&&this.$el.css("minHeight",this.options.minHeight),this.options.minWidth&&this.$el.css("minWidth",this.options.minWidth),this.options.maxWidth&&this.$el.css("maxWidth",this.options.maxWidth),this.setContent(this.options.content),this.setHeader(this.options.header),this.options.buttons&&this.setButtons(this.options.buttons)},onReady:function(){this.options.isAutoShow&&this.show(),c.isFunction(this.options.readyCallback)&&this.options.readyCallback(this)},onFadeClick:function(a,b){!this.isModal()&&this.isVisible()&&(!c.isjQueryObject(b.target)||0===b.target.closest(".b-popup").size()&&0!==b.target.closest(document.body).size())&&this.hide()},onCloseClick:function(){this.hide()},onBodyKeyDown:function(a){27===a.keyCode&&!this.isModal()&&this.isVisible()&&this.hide()}},static:{create:function(a){return new j(a)},getVisibleCount:function(){return a(".b-popup:visible").size()}}});return j});