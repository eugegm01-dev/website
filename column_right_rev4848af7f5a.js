define(["jquery","factory","counters","audio-player","util/scroll"],function(a,b,c,d,e){"use strict";function f(){b("product-tools/auth-form",function(a){a.show()})}var g={button:".js-show_music_suggest",search:"#mm-music-suggest",playlist:".js-jp__playlist",communityMembers:"[data-members-dir]",authPopup:'[data-action="openAuthPopup"]',visitorDelete:".js-visitor_delete"},h="b-column-right-not-position";return{create:function(){var c=this;return{onLoad:function(h){var i=null;c.container=h,c.containerFixed=h.find(".b-column-right__fixed"),c.containerBlocks=h.find(".mm-column-right__container-blocks"),c.carouselIndex=0,c.tryCarouselLoad=!1,c.blockIsVisible=[],c.showBlockSingle=!1,c.carouselClassList=[".b-column-right__apps-list",".b-column-right__users-list"],c.carouselList=[],c.carouselClassList.forEach(function(a){var b=c.container.find(a);b&&b.length>0&&c.carouselList.push(a)}.bind(c)),h.on("click",g.button,function(a){a.preventDefault(),i&&(clearTimeout(i),i=null),h.find(g.search).show().find("input[type=text]").focus()}),h.on("click",g.authPopup,function(a){a.preventDefault(),a.stopPropagation(),f()}),h.on("click",g.visitorDelete,function(d){d.preventDefault(),d.stopPropagation(),c.Visitors||b("visitors",function(b){c.Visitors=b.create(),c.Visitors.onLoad(h.find(".js-right-block-visitors")),c.Visitors.deleteVisitor(a(d.target))})}),h.find(g.search+" > input[type=text]").on("blur",function(){i=setTimeout(function(){h.find(g.search).hide()},300)}),h.find(g.playlist).each(function(a,b){var c=d.createPlaylist({id:"column-right-player-"+a,element:b});c.createTracks()}),h.find(g.communityMembers).each(function(b,c){var d=a(c).data("membersDir");return a(c).attr("href",d),b}),c.onScrollHandler=c.onScroll.bind(c),e.on(c.onScrollHandler),h.find(".b-column-right__block-apps").length&&c.initApps(),h.find(".b-column-right__block-sale").length&&c.initAppsSale()},onUnload:function(){c.container.off("click"),c.container.find(g.search+" > input[type=text]").off("blur"),c.apps&&(c.apps.destroy(),delete c.apps),c.saleApps&&(c.saleApps.destroy(),delete c.saleApps),c.Visitors&&c.Visitors.onUnload(),e.off(c.onScrollHandler)}}},onScroll:function(a,b){var c,d=this.containerFixed.find(".b-right-column__block"),e="b-column-right__block-visible",f=".b-right-column__carousel__inner__list-item",g="b-column-right__block-news-cloud",i=b.scrollTop;d.length&&(i>this.containerBlocks.outerHeight()+40?(this.containerFixed.find(f).length||this.containerFixed.hasClass(g))&&(d.parent().addClass(e),(this.appsShowImmediately||this.saleAppsShowImmediately)&&(c=this.containerFixed.outerHeight(!0),this.containerFixed.removeClass(h),c&&this.containerBlocks.css({paddingBottom:c+"px"}))):i<this.containerBlocks.outerHeight()+150&&(d.parent().removeClass(e),(this.appsShowImmediately||this.saleAppsShowImmediately)&&(this.containerFixed.addClass(h),this.containerBlocks.css({paddingBottom:""}))))},initApps:function(c){b("home/column_right/apps",function(b){var d=".b-column-right__block-",e=this.container.find(d+"apps");this.apps=b.createRunTime({load:c},e).on("allRender",function(){var b;this.appsShowImmediately&&(b=a(window).scrollTop(),b>this.containerBlocks.height()+30?this.containerFixed.removeClass(h):b<this.containerBlocks.height()+150&&this.containerFixed.addClass(h))}.bind(this)),this.appsShowImmediately=this.apps.options.showImmediately}.bind(this))},initAppsSale:function(c){b("home/column_right/sale",function(b){var d=".b-column-right__block-",e=this.container.find(d+"sale");this.saleApps=b.createRunTime({load:c},e).on("allRender",function(){var b;this.container[0].classList.add("mm-column-right_hasAppSale"),this.saleAppsShowImmediately&&(b=a(window).scrollTop(),b>this.containerBlocks.height()+30?this.containerFixed.removeClass(h):b<this.containerBlocks.height()+150&&this.containerFixed.addClass(h))}.bind(this)),this.saleAppsShowImmediately=this.saleApps.options.showImmediately}.bind(this))},inited:function(){return this.container}}});