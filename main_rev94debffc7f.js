define(["jquery","counters","base/view","app/comet","util/scroll","util/resize","util/lazy-background","client-server"],function(a,b,c,d,e,f,g,h){"use strict";var i="/my/vip",j=c.extend({props:{deferred:{apps:"left-menu/apps",appsOld:"left-menu/apps-old"},templates:{menu:"left-menu/tmpl/main"},elements:{items:".b-left-menu__item",games:".b-left-menu__games",scroller:".b-left-menu__scroller",scrollerIcon:".b-left-menu__scroller__icon"},events:{mouseover:"onMouseOver","click [data-genre]":"onGenreClick","click .b-left-menu__item":"onItemClick","click .b-left-menu__scroller":{delegate:!1,method:"onScrollerClick"},"click [data-vip-badge]":"onVIPBadgeClick"},vars:{offsetTop:null,height:null,headHeight:null,headMenuHeight:null,headBannerHeight:null,footerHeight:null,isAppsInited:!1,scrollerOffsetTop:null,isNeedScroller:!1,isScrollerVisible:!1},optionsSelector:"#left-menu-options",defaultOptions:{scrollerAnimationDuration:500,minWindowWidth:975,links:["/","/my/friends_requests","/friends","/my/photo","/my/communities","/my/gifts?send"]},cssClasses:{item:"b-left-menu__item",link:"b-left-menu__item__link",counter:"b-left-menu__item__counter",selected:"b-left-menu__item_selected",fixed:"b-left-menu_fixed",scrollerVisible:"b-left-menu__scroller_visible",leftColumnBanners:"#leftColumnBanners"},scrollerOpacity:{min:.05,max:.8,ratio:1.5},counters:{feed:1472221,feedSelf:3551908,friends:841560,photo:841565,video:841568,music:841569,groups:841573,gifts:841577},scrollerViewBoxHeight:130},public:{init:function(){var b;this.offsetTop=this.$el.offset().top,this.height=this.$el.height(),this.headHeight=a(document.body).hasClass("head-fixed")?a(".b-head").height()+this.height:a(".b-head").height(),this.headMenuHeight=a(".portal-menu").size()?a(".portal-menu").height():a(".b-head__menu").height(),this.headBannerHeight=0,this.footerHeight=a(".b-footer").height(),this.$feedCounter=this.$el.find(".b-left-menu__item__feed-counter"),this.updateState(),this.onWindowScrollHandler=this.onWindowScroll.bind(this),e.on(this.onWindowScrollHandler),this.onWindowResizeHandler=this.onWindowResize.bind(this),f.on(this.onWindowResizeHandler),this.onBoosterLoadedHandler=this.onBoosterLoaded.bind(this),a(document.body).on("booster:loaded",this.onBoosterLoadedHandler),this.onBannerLoadedHandler=this.onBannerLoaded.bind(this),a(document.body).on("banner.loaded",this.onBannerLoadedHandler),this.onCometHandler=this.onComet.bind(this),d.pushEvent.on(this.onCometHandler),this.checkFixed().initScroller(),g.check(),b=this.$el.find('[data-type="history-config-main"]');var c=b.html()||"{}";return a.extend(!0,this.options,JSON.parse(c.replace(/\r|\n|\t|\s{2,}/g,""))),!document.querySelector(".l-app.m-reskin-2019")&&this.options.updateTimeout&&this.setWatcherTimer(this.options.updateTimeout.start),this},destroy:function(){return this}},protected:{getItemElementByDataId:function(a){return this.$items.filter("[data-id="+a+"]")},getItemElementByLinkHref:function(b){var c="."+this.cssClasses.link;return this.$items.filter(function(){return a(this).find(c).attr("href")===b})},updateState:function(){var a=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0;return this.isNeedScroller=window.innerHeight>this.offsetTop+this.height+this.scrollerViewBoxHeight,this.scrollerProcessing(a),this},isNeedFixed:function(){var b=Boolean(a(this.cssClasses.leftColumnBanners).length);if(b)return!1;this.headBannerHeight=a(".b-head__banner").height();var c=document.querySelector(".l-app.m-reskin-2019"),d=c?this.headHeight:this.headHeight-this.headMenuHeight,e=c?parseFloat(window.getComputedStyle(c)["padding-top"])||0:0,f=c?10:0,g=a(".l-app > .app-top-actions").toArray().reduceRight(function(b,c){return b+a(c).outerHeight()},0),h=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,i=window.innerHeight>this.height+this.headMenuHeight+this.headBannerHeight+g+this.footerHeight,j=window.innerWidth>=this.options.minWindowWidth,k=h>d+this.headBannerHeight+g+e-f;return i&&j&&k},checkFixed:function(){return this.isNeedFixed()?this.$el.addClass(this.cssClasses.fixed):this.$el.removeClass(this.cssClasses.fixed),this},initScroller:function(){if(this.$scroller.size()){var a=this.$scroller.position().top;a-100>0?this.scrollerOffsetTop=a-100:this.scrollerOffsetTop=300}return this},scrollerProcessing:function(a){var b;this.isNeedScroller?(a>this.scrollerOffsetTop&&!this.isScrollerVisible?(this.$scroller.addClass(this.cssClasses.scrollerVisible),this.isScrollerVisible=!0):a<=this.scrollerOffsetTop&&this.isScrollerVisible&&(this.$scroller.removeClass(this.cssClasses.scrollerVisible),this.isScrollerVisible=!1),this.isScrollerVisible&&(b=Number((a-this.scrollerOffsetTop)/(1e3*this.scrollerOpacity.ratio)).toPrecision(2),b>=this.scrollerOpacity.min&&b<=this.scrollerOpacity.max?this.$scrollerIcon.css("opacity",b):b>this.scrollerOpacity.max&&this.$scrollerIcon.css("opacity",b))):(this.$scroller.removeClass(this.cssClasses.scrollerVisible),this.isScrollerVisible=!1)},onWindowScroll:function(a,b){this.checkFixed().scrollerProcessing(b.scrollTop)},onWindowResize:function(a,b){this.checkFixed().updateState()},onBoosterLoaded:function(a,b){this.checkFixed(),this.$items.removeClass(this.cssClasses.selected),this.options.links.forEach(function(a){var b=location.pathname+location.search;0===b.indexOf(a)&&"/"!==a&&this.getItemElementByLinkHref(a).addClass(this.cssClasses.selected)}.bind(this)),"/"===location.pathname&&(this.$feedCounter.hide(),this.getItemElementByDataId("feed").addClass(this.cssClasses.selected)),location.href.indexOf("is_chrono=1")!==-1&&this.$feedCounter.parent().attr("href","/")},onComet:function(a,b){"left-column-numbers"===b.name&&b.data&&Object.keys(b.data).forEach(function(a){var c,d,e=b.data[a];"communities"===a&&(a="groups"),c=this.getItemElementByDataId(a),c.size()&&(d=c.find("."+this.cssClasses.counter),e>=0&&(d.text(e),e>0?d.show():d.hide()))}.bind(this))},onMouseOver:function(a,b){if(!this.isAppsInited){var c=this.options.oldCatalog?"appsOld":"apps";this.require(c,function(a){a.createRunTime(this.$games).init()}),this.isAppsInited=!0}},onItemClick:function(a,c){var d=a.find("."+this.cssClasses.link),e=a.data("id");e&&(this.counters[e]&&b.myrb(this.counters[e]),"feed"===e&&a.hasClass(this.cssClasses.selected)&&b.myrb(this.counters.feedSelf),d&&d.size()&&"_blank"!==d.attr("target")&&(this.$items.removeClass(this.cssClasses.selected),a.addClass(this.cssClasses.selected)))},onGenreClick:function(b,c){a(document.body).trigger("apps.changeGenre",[b,c])},onScrollerClick:function(b,c){a("html:not(:animated),body:not(:animated)").animate({scrollTop:0},this.options.scrollerAnimationDuration),this.$scroller.removeClass(this.cssClasses.scrollerVisible)},onVIPBadgeClick:function(a,b){b.preventDefault(),b.stopPropagation(),window.location=i},onBannerLoaded:function(b,c){this.headBannerHeight=a(".b-head__banner").height()},setWatcherTimer:function(a,b){localStorage.lastHistoryViewTime||(localStorage.lastHistoryViewTime=Math.round(Date.now()/1e3)),this.watcherTimer=setTimeout(function(){var c=location.pathname.indexOf("apps")>-1;location.pathname.indexOf("/app/subcatalog")>=0||("/"===location.pathname||c||"/?is_chrono=1"===location.pathname?(this.$feedCounter.hide(),this.$feedCounter.parent().attr("href","/"),this.setWatcherTimer(a)):h.func("history.last_events_time",{time:localStorage.lastHistoryViewTime},{success:function(c){var d=JSON.parse(c)[2];d.count>0?(this.$feedCounter.show(),this.$feedCounter.parent().attr("href","/?is_chrono=1")):(this.$feedCounter.hide(),this.$feedCounter.parent().attr("href","/")),this.$feedCounter.html(this.formatEventsCount(d.count>999?"+999":d.count)),this.$feedCounter.toggleClass("_single",1===d.count),a=d.count!==b?this.options.updateTimeout.start:Math.min(a*this.options.updateTimeout.rate,this.options.updateTimeout.max),this.setWatcherTimer(a,d.count)}.bind(this),error:function(){this.setWatcherTimer(a,b)}.bind(this)}))}.bind(this),1e3*a)},formatEventsCount:function(a){return parseInt(a,10)<100?a:"99+"}}});return j});