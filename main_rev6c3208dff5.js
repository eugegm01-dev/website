define(["jquery","client-server","factory","base/view","util/promise","util/helpers","util/resize","util/scroll","util/css-manager","util/drag-and-drop","app/comet","models/user/journal","models/user/active","external/cookie","util/htmlescape"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){"use strict";var p=d.extend({props:{deferred:{stat:"publisher/stat",photoUploadPopup:"content-tools/photo/upload/popup",audioUploadPopup:"content-tools/audio/upload/popup",videoUploadPopup:"content-tools/video/upload-popup",photoUploader:"content-tools/photo/upload/files/uploader",audioUploader:"content-tools/audio/upload/files/uploader",photoItem:"publisher/photo",audioItem:"publisher/audio",multipost:"models/history/multipost",hashtag:"models/hashtag/hashtag",mention:"mention/mention",photo:"models/media/photo/item",audioPlayer:"audio-player",dateTime:"util/date-time",calendar:"jquery-ui/datepicker",calendarRu:"jquery-ui-i18n/jquery.ui.datepicker-ru",autosize:"libs/autosize",textcomplete:"jquery.textcomplete",highlightWithinTextarea:"jquery.highlight-within-textarea",verify:"verify",jqueryUiPosition:"jquery-ui/position"},templates:{publisher:"publisher/tmpl/publisher",delay:"publisher/tmpl/delay",photo:"publisher/tmpl/photo",audio:"publisher/tmpl/audio",video:"publisher/tmpl/video",share:"publisher/tmpl/share"},elements:{text:".b-publisher__text",textCounter:".b-publisher__text-counter",delay:".b-publisher__delay-wrapper",externalUrl:".b-publisher__external-url",externalUrlInput:".b-publisher__external-url__input",externalUrlError:".b-publisher__external-url__error",delayDate:".b-publisher__delay__date",delayHours:".b-publisher__delay__hours",delayMinutes:".b-publisher__delay__minutes",hintHashtag:".b-publisher__hint-hashtag",resultPhoto:".b-publisher__result__photo",resultPhotoList:".b-publisher__result__photo__items",resultAudio:".b-publisher__result__audio",resultAudioList:".b-publisher__result__audio__items",resultVideo:".b-publisher__result__video",resultAudioItems:".b-publisher__result__audio__item",controlSticky:".b-publisher__controls__item-button_sticky",controlDelay:".b-publisher__controls__item-button_delay",controlProhibitComments:".b-publisher__controls__item-button_prohibitComments",controlStatus:".b-publisher__controls__status__checkbox",shareWrapper:".b-publisher__share-wrapper",share:".b-publisher__share",shareImage:".b-publisher__share__images__image",shareSliderText:".b-publisher__share__images__slider__text",shareTitleText:".b-publisher__share__title__text",shareTitleInput:".b-publisher__share__title__input",shareDescriptionText:".b-publisher__share__description__text",shareDescriptionInput:".b-publisher__share__description__input",submit:".b-publisher__controls__submit",iconMention:".b-publisher__icon-mention"},events:{"focus .b-publisher__text":{delegate:!1,method:"onTextFocus"},"blur .b-publisher__share__title__input":{delegate:!1,method:"onShareTitleInputBlur"},"blur .b-publisher__share__description__input":{delegate:!1,method:"onShareDescriptionInputBlur"},"input .b-publisher__text":"onTextInput","input .b-publisher__external-url__input":"onExternalUrlInput","click .b-publisher__controls__item_photo":{method:"onControlPhotoClick",throttling:1e3},"click .b-publisher__controls__item_audio":{method:"onControlAudioClick",throttling:1e3},"click .b-publisher__controls__item_video":{method:"onControlVideoClick",throttling:1e3},"click .b-publisher__controls__item_external-url":"onControlExternalUrlClick","click .b-publisher__controls__item-button_sticky":"onControlStickyClick","click .b-publisher__controls__item-button_delay":"onControlDelayClick","click .b-publisher__controls__item-button_prohibitComments":"onControlProhibitCommentsClick","click .b-publisher__controls__submit":{method:"onSubmitClick",throttling:1e3},"click .b-publisher__result__photo__item__remove":"onPhotoRemoveClick","click .b-publisher__result__audio__item__remove":"onAudioRemoveClick","click .b-publisher__result__video__item__remove":"onVideoRemoveClick","click .b-publisher__delay__cancel":"onDelayCancelClick","click .b-publisher__share__images__slider__right":"onShareImageRightClick","click .b-publisher__share__images__slider__left":"onShareImageLeftClick","click .b-publisher__share__cancel":"onShareCancelClick","click .b-publisher__share__title__edit":"onShareTitleEditClick","click .b-publisher__share__description__edit":"onShareDescriptionEditClick","click .b-publisher__share__images__image__remove":"onShareImageRemove","click .b-publisher__icon-hashtag":"onIconHashtagClick","click .b-publisher__icon-mention":"onIconMentionClick","change .b-publisher__delay__date":"onDelayDateChange","change .b-publisher__delay__hours":"onDelayDateHoursChange","change .b-publisher__delay__minutes":"onDelayDateMinutesChange","change .b-publisher__share__title__input":"onShareTitleInputChange","change .b-publisher__share__description__input":"onShareDescriptionInputChange","change .b-publisher__controls__status__checkbox":"onControlStatusChange"},cssClasses:{photoItem:"b-publisher__result__photo__item",audioItem:"b-publisher__result__audio__item",videoItem:"b-publisher__result__video__item",photoItemError:"b-publisher__result__photo__item_error",audioItemUploaded:"b-publisher__result__audio__item_upload-file",audioItemDone:"b-publisher__result__audio__item_done",resultPhotoList:"b-publisher__result__photo__items",resultAudioList:"b-publisher__result__audio__items",limitTextWarn:"b-publisher_text-limit-warn",moveHere:"b-publisher_move-here",dropHere:"b-publisher_drop-here",share:"b-publisher_share",shareTitleEdit:"b-publisher__share_title-edit",shareDescriptionEdit:"b-publisher__share_description-edit",shareWithoutImage:"b-publisher__share_without-image"},defaultOptions:{isCollectElements:!0,isEnableStatus:!0,isEnableExternalUrl:!1,isEnableSticky:!1,isEnableDelay:!1,isEnableProhibitComments:!1,isEnableShare:!0,isGuestBook:!1,isEnableMediaContent:!1,isEnableHashtag:!1,textHeight:18,animationRemoveDuration:300,shareCheckDelay:300,textcompleteDelay:300,checkUploadTimeout:3e4,urlRegExp:/(http[s]?:\/\/){0,1}(www\.){0,1}[а-яА-ЯёЁ\w0-9\.\-]+\.[а-яА-ЯёЁ\w]{2,5}[\?=\/а-яА-ЯёЁ\w%\.0-9_\-&]*/gi,imgUrlRegExp:/(http[s]?:\/\/){0,1}(www\.){0,1}[а-яА-ЯёЁ\w0-9\.\-]+\.[а-яА-ЯёЁ\w]{2,5}[\?=\/а-яА-ЯёЁ\w%\.0-9_\-&]*\.(jpg|jpeg|bpm|gif|png)(?=\s|$)/gi,photo:{uploaderAlbum:"_publisher",uploaderQueueSize:10,uploaderPreviewQueueSize:10,uploaderHostCount:1,uploaderLimit:0,previewSize:86},audio:{popupHeight:515,uploaderQueueSize:10,uploaderHostCount:1,uploaderLimit:0},limit:{text:100,textWarn:50,mention:10},vkPlayProdHost:"vkplay.live"}},public:{init:function(){return this.isPublisherInited=!1,this.isPublisherRendered=!1,this.isDelayInited=!1,this.shareCurrentUrl=null,this.shareCanceledUrls=[],this.processedImgUrls=[],this.timersCheckTimeout=[],this.shareCurrentImage=-1,this.shareCheckTimer=null,this.isEnableSubmit=!1,n.get("_sp_model")&&(this.options.upload.photo.uploadUrl=(n.get("_sp_model")||"")+"/uploadphoto",this.options.upload.audio.uploadUrl=(n.get("_sp_model")||"")+"/uploadaudio"),this.onSetDelayedPostHandler=this.onSetDelayedPost.bind(this),a(document.body).on("publisher.setLastDelayedPost",this.onSetDelayedPostHandler),this.dragAndDropHandlerId=j.on(document.body,{over:this.onBodyDragOver.bind(this),out:this.onBodyDragOut.bind(this),drop:this.onBodyDrop.bind(this)}),this.$text.is(":focus")&&this.expand(),this.$text.attr("maxlength",this.options.limit.text),this.onCometHandler=this.onComet.bind(this),k.pushEvent.on(this.onCometHandler),this.require("stat",function(a){this.stat=new a,this.stat.init(this)}.bind(this)),this},destroy:function(){return this.photoUploadPopup&&this.photoUploadPopup.destroy(),this.audioUploadPopup&&this.audioUploadPopup.destroy(),this.videoUploader&&this.videoUploader.destroy(),a(document.body).off("publisher.setLastDelayedPost",this.onSetDelayedPostHandler),j.off(document.body,this.dragAndDropHandlerId),this.highligtTextarea&&(this.$text.data("hwt").destroy(),this.highligtTextarea=null),this.textcomplete&&(this.$text.textcomplete("destroy"),this.$text.textcomplete=null),this.onWindowResizeHandler&&(g.off(this.onWindowResizeHandler),delete this.onWindowResizeHandler),this.onWindowScrollHandler&&(h.off(this.onWindowScrollHandler),delete this.onWindowScrollHandler),k.pushEvent.off(this.onCometHandler),delete this.onCometHandler,p.__super__.destroy.call(this),this},getText:function(){return this.$text.val().trim()},enableSubmit:function(){return this.isEnableSubmit=!0,this.$submit.removeClass("disable").removeAttr("disabled"),this},disableSubmit:function(){return this.isEnableSubmit=!1,this.$submit.addClass("disable").attr("disabled","disabled"),this},reset:function(){return this.multipost.set({content:[],text:"",photo:[],audio:[],video:[],shareUrl:"",externalUrl:"",isDelay:!1,isSticky:!1,isProhibitComments:!1}),this.shareCurrentUrl=null,this.processedImgUrls=[],this.$resultPhoto.html(""),this.$resultAudio.html(""),this.$resultVideo.html(""),this.textcomplete&&(this.$text.textcomplete("destroy"),this.textcomplete=null),this.onWindowResizeHandler&&(g.off(this.onWindowResizeHandler),delete this.onWindowResizeHandler),this.onWindowScrollHandler&&(h.off(this.onWindowScrollHandler),delete this.onWindowScrollHandler),this.highligtTextarea&&(this.$text.data("hwt").destroy(),this.highligtTextarea=null),this.$text.height(this.options.textHeight).val(""),this.$shareWrapper.html("").removeClass("show"),this.hideDelay(),this.$controlSticky.removeClass("selected"),this.$controlProhibitComments.removeClass("selected"),this.$externalUrl.removeClass("show"),this.$externalUrlInput.val(""),this.$el.removeClass(this.cssClasses.limitTextWarn).removeClass(this.cssClasses.share),this.mention&&this.$iconMention.removeClass("disabled"),this.photoUploader&&this.photoUploader.clear(),this.audioUploader&&this.audioUploader.clear(),this.disableSubmit(),this.toggleDisabledStatus(!0),this.clearEls(),this}},protected:{expand:function(){var a,b,c;return(this.hashtag||this.mention)&&(this.initTextcomplete(),this.initHighlight()),new e(function(d){var f=[];this.isPublisherInited?this.isPublisherRendered&&d():(b=new e(function(a){i.require("publisher",a)}),a=new e(function(a){this.render("publisher",{isEnableSubmit:this.isEnableSubmit}).then(function(b){c=b,a()}.bind(this))}.bind(this)),this.require("autosize",function(a){this.$text.attr("rows","1"),a(this.$text)}.bind(this)),e.all([a,b]).then(function(){c.appendTo(this.$el),this.isPublisherRendered=!0,this.updateElements(),this.isEnableSubmit&&this.enableSubmit(),this.getText()&&this.checkExternalUrls(),d()}.bind(this)),this.require("multipost",function(a){this.multipost=new a({isStatus:this.options.isEnableStatus},{user:this.options.user||l.get("email"),isEnableMediaContent:this.options.isEnableMediaContent,isEnableHashtag:this.options.isEnableHashtag,isEnableMention:this.options.isEnableMention,maxMentionUser:this.options.limit.mention}),this.multipost.set("text",this.getText()),this.onChange()}.bind(this)),this.initPhotoUploader(),this.initAudioUploader(),this.options.isEnableHashtag&&f.push(this.require("hashtag",function(a){this.hashtag=new a}.bind(this))),this.options.isEnableMention&&f.push(this.require("mention",function(a){this.mention=new a({isPublisher:!0})}.bind(this))),f.length&&e.all(f).then(function(){this.initTextcomplete(),this.initHighlight()}.bind(this)),this.isPublisherInited=!0)}.bind(this))},initTextcomplete:function(){this.textcomplete||this.require("textcomplete",function(){var b=[];this.hashtag&&b.push({match:this.hashtag.getRegexprSearch(),search:this.hashtag.search.bind(this),index:1,replace:function(a,b){return"#"+a+" "}.bind(this)}),this.mention&&b.push({match:this.mention.getRegexprSearch(),search:function(){this.getTextcompleteDropdown().filter(":visible").length||this.trigger("mentionShowDropdown"),this.mention.getUsers.apply(this.mention,arguments)}.bind(this),replace:function(a,b){return this.multipost.setMentionUser(a,this.mention.getUserByName(a)),this.trigger("mentionSelectUser"),"$1<@"+a+"> "}.bind(this),index:2,context:function(){return this.multipost.getMentionCount()<this.options.limit.mention}.bind(this),template:function(a){var b=this.mention.getUserByName(a),c=b&&b.get("avatar32");return f.stringFormat('<span class="b-mention-dropdown-avatar" style="background-image: url(%s);"></span><span class="b-mention-dropdown-name">%s</span>',c,o.escape(a))}.bind(this)}),this.textcomplete=this.$text.textcomplete(b,{zIndex:105,debounce:this.options.textcompleteDelay,listPosition:function(){this.setTextcompeleDropdownPosition()}.bind(this)}).on("textComplete:select",function(){a.browser.msie&&a.browser.version<=11?this.$text.trigger("keyup"):this.$text.trigger("input"),this.multipost.set("text",this.getText())}.bind(this))}.bind(this)),this.onWindowResizeHandler||(this.onWindowResizeHandler=this.onWindowResize.bind(this),g.on(this.onWindowResizeHandler)),this.onWindowScrollHandler||(this.onWindowScrollHandler=this.onWindowScroll.bind(this),h.on(this.onWindowScrollHandler))},initHighlight:function(){this.highligtTextarea||this.require("highlightWithinTextarea",function(){var b;this.highligtTextarea=this.$text.highlightWithinTextarea(function(){var a=[];return this.hashtag&&(a=a.concat(this.hashtag.onInput.apply(this,arguments))),this.mention&&(a=a.concat(this.mention.getHighlightPosition.apply(this.mention,arguments))),a.sort(function(a,b){return a[0]>b[0]?1:-1})}.bind(this)),a.browser.msie&&a.browser.version<=11&&(b=this.$text.data("hwt"),b.$el.on("keyup.hwt",b.handleInput.bind(b))),this.$text.focus()}.bind(this))},initPhotoUploader:function(){i.require("content-tools",function(){this.require("photoUploader",function(a){this.photoUploader=new a({user:this.options.isGuestBook?m.get("email"):l.get("email"),uploadUrl:this.options.upload.photo.uploadUrl,album:this.options.photo.uploaderAlbum,previewSize:this.options.photo.previewSize,$container:this.$el,queueSize:this.options.photo.uploaderQueueSize,previewQueueSize:this.options.photo.uploaderPreviewQueueSize,hostCount:this.options.photo.uploaderHostCount,limit:this.options.photo.uploaderLimit,multiple:!0}),this.photoUploader.on("start",this.onPhotoUploaderStart.bind(this)).on("success",this.onPhotoUploaderSuccess.bind(this)).on("error",this.onPhotoUploaderError.bind(this)).on("remove",this.onPhotoUploaderRemove.bind(this))}.bind(this))}.bind(this))},initAudioUploader:function(){i.require("content-tools",function(){this.require("audioUploader",function(a){this.audioUploader=new a({user:this.options.isGuestBook?m.get("email"):l.get("email"),uploadUrl:this.options.upload.audio.uploadUrl,$container:this.$el,queueSize:this.options.audio.uploaderQueueSize,hostCount:this.options.audio.uploaderHostCount,limit:this.options.audio.uploaderLimit,multiple:!0,isForMultiPost:!0}),this.audioUploader.on("start",this.onAudioUploaderStart.bind(this)).on("success",this.onAudioUploaderSuccess.bind(this)).on("error",this.onAudioUploaderError.bind(this)).on("remove",this.onAudioUploaderRemove.bind(this))}.bind(this))}.bind(this))},photoUploaderUpdate:function(){this.photoUploadCounters.done+this.photoUploadCounters.fail+this.photoUploadCounters.remove===this.photoUploadCounters.all&&(this.multipost.addPhoto(this.photoUploader.getItems().filter(function(a){return!!a.get("id")&&!a.isRemoved()}).map(function(a){return{id:a.get("id"),albumId:a.get("albumId"),ownerId:this.options.isGuestBook?m.get("id"):l.get("id"),preview:a.get("preview")}}.bind(this))),this.onChange(),this.photoUploader.clear(),this.trigger("addPhoto",{from:"files"}))},audioUploaderUpdate:function(){this.audioUploadCounters.done+this.audioUploadCounters.fail+this.audioUploadCounters.remove===this.audioUploadCounters.all&&(this.multipost.addAudio(this.audioUploader.getItems().filter(function(a){return!!a.get("id")&&!a.isRemoved()}).map(function(a){return{id:a.get("id"),ownerId:this.options.isGuestBook?m.get("id"):l.get("id"),name:a.get("name"),author:a.get("author"),url:a.get("url"),uid:a.get("ownerId"),duration:a.get("duration"),ownerDir:a.get("ownerDir"),ownerName:a.get("ownerName")}}.bind(this))),this.onChange(),this.audioUploader.clear(),this.trigger("addAudio",{from:"files"}))},removeItem:function(a,b){a.size()&&(this.multipost.removeItem(b,a.data("id")),a.addClass("hide"),setTimeout(function(){a.remove()},this.options.animationRemoveDuration))},toggleSticky:function(){this.multipost.set("isSticky",!this.multipost.get("isSticky")),this.$controlSticky.toggleClass("selected",this.multipost.get("isSticky"))},showDelay:function(){this.$controlDelay.addClass("selected"),this.$controlSticky.removeClass("selected").addClass("disable").attr("disabled","disabled"),this.isDelayInited?this.$delay.addClass("show"):(i.require("components.datepicker.datepicker"),this.render("delay",function(b){this.require(["dateTime","calendar","calendarRu"],function(b){var c=Number(this.options.lastDelayedPostTime),d=c?new Date(c+36e5):new Date;a.extend(a.datepicker.regional.ru),this.$delayDate.datepicker({dateFormat:"d MM yy",monthNames:b.getMonthsLeft(),minDate:new Date,nextText:"",prevText:"",beforeShow:function(a,b){setTimeout(function(){var a=this.$delayDate.offset(),c=this.$delayDate.outerHeight();b.dpDiv.css({top:a.top+c,left:a.left})}.bind(this))}.bind(this),onSelect:function(a,b){b.dpDiv.css("display","none"),b.input.trigger("change")}.bind(this)}),this.setDelayDate(d)}.bind(this)),b.appendTo(this.$delay),this.updateElements(),this.$delay.addClass("show")}.bind(this)),this.isDelayInited=!0),this.multipost.set("isDelay",!0)},hideDelay:function(){this.$delay.removeClass("show"),this.$controlDelay.removeClass("selected"),this.$controlSticky.removeClass("disable").removeAttr("disabled"),this.multipost.get("isSticky")&&this.$controlSticky.addClass("selected"),this.multipost.set("isDelay",!1)},toggleDelay:function(){this.multipost.get("isDelay")?this.hideDelay():this.showDelay()},setDelayDate:function(b){if(this.multipost){var c=b.getHours(),d=b.getMinutes();d=5*Math.ceil(d/5)%60,this.multipost.set("delayDate",b),this.require("dateTime",function(e){var f=a.datepicker.formatDate("d MM yy",b,{monthNames:e.getMonthsLeft()});this.$delayHours.val(c),this.$delayMinutes.val(d),this.$delayDate.val(f)}.bind(this))}},toggleProhibitComments:function(){this.multipost.set("isProhibitComments",!this.multipost.get("isProhibitComments")),this.$controlProhibitComments.toggleClass("selected",this.multipost.get("isProhibitComments"))},isCanAddShare:function(){return this.multipost&&!this.multipost.get("audio").length&&!this.multipost.get("photo").length&&!this.multipost.get("video").length&&!this.multipost.get("isDelay")&&!this.multipost.get("isSticky")&&!this.multipost.get("isProhibitComments")},checkExternalUrls:function(){var a=this.getText(),b=a.match(this.options.urlRegExp),c=a.match(this.options.imgUrlRegExp),d=[],e=[];this.multipost&&this.multipost.set("text",a),b&&this.isCanAddShare()&&this.options.isEnableShare&&(d=b.filter(function(a){return this.shareCanceledUrls.indexOf(a)===-1&&!a.match(this.options.imgUrlRegExp)}.bind(this))),c&&(e=c.filter(function(a){return this.processedImgUrls.indexOf(a)===-1}.bind(this))),e.length&&!this.shareCurrentUrl&&(this.processedImgUrls=this.processedImgUrls.concat(e),this.require("photo",function(a){e.forEach(function(b){var c=this.options.isGuestBook?m.get("email"):l.get("email"),d=new a({externalUrl:b,albumId:this.options.photo.uploaderAlbum});d.uploadByExternalUrl(c).then(function(){this.multipost.addPhoto({id:d.get("id"),albumId:d.get("albumId"),ownerId:this.options.isGuestBook?m.get("id"):l.get("id"),preview:d.get("preview"),srcUrl:b,isUploadByUrl:!0}),this.timersCheckTimeout[d.get("id")]=setTimeout(function(){d.checkUpload(c).then(this.onUploadPhotoByExternalUrlSuccess.bind(this,d),this.onUploadPhotoByExternalUrlError.bind(this,d))}.bind(this),this.options.checkUploadTimeout),this.render("photo",{items:this.multipost.get("photo"),locales:this.options.locales}).then(function(a){this.$resultPhoto.html(a).addClass("show")}.bind(this))}.bind(this))}.bind(this))}.bind(this))),d.length&&d[0]!==this.shareCurrentUrl&&(this.shareCurrentUrl=d[0],this.multipost.getShare(this.shareCurrentUrl).then(function(a){var b=Boolean(a.video_embed&&a.video_embed.includes(this.options.vkPlayProdHost));if(this.isCanAddShare()){if(a.title||a.description||a.images.length||b){this.shareCurrentImage=0,this.shareImages=a.images,this.shareRawImages=a.rawImages;var c=a.url.indexOf("?")!==-1,d=c?"&":"?";this.multipost.set({content:[],photo:[],video:[],audio:[],shareUrl:a.url+(b?d+"utm_source=mm":""),shareTitle:a.title,shareDescription:a.description,shareImage:a.rawImages[0],shareVideoUrl:a.video.url,embedVideoUrl:a.video_embed,shareVideoWidth:a.video.width,shareVideoHeight:a.video.height}),this.clearEls(),this.render("share",{title:a.title,description:a.description,images:a.images,imagesCount:a.images.length,showSlider:a.images.length>1,image:a.images[0]}).then(function(a){a.appendTo(this.$shareWrapper.html("")),this.$el.addClass(this.cssClasses.share)}.bind(this))}}else this.shareCurrentUrl=null}.bind(this)))},showCurrentShareImage:function(){this.multipost.set("shareImage",this.shareRawImages[this.shareCurrentImage]),this.$shareImage.css({backgroundImage:'url("'+this.shareImages[this.shareCurrentImage]+'")'}),this.$shareSliderText.text(this.shareCurrentImage+1+" "+this.options.locales.share.from+" "+this.shareImages.length)},cancelShare:function(){this.shareCanceledUrls.push(this.multipost.get("shareUrl")),this.multipost.set("shareUrl",""),this.shareCurrentUrl=null,this.$shareWrapper.html(""),this.$el.removeClass(this.cssClasses.share),this.trigger("shareRemove")},createAudioPlayList:function(a){return new e(function(b){!this.playlist||a?this.require("audioPlayer",function(a){this.playlist=a.createPlaylist({id:"publisher-audio-playlist",element:this.$resultAudio,fragment:"publisher"}),b(this.playlist)}.bind(this)):b(this.playlist)}.bind(this))},insertToText:function(b){var c,d,e,f,g=this.$text.get(0),h=this.$text.scrollTop();return g.selectionStart||0===g.selectionStart?(e=g.selectionStart,f=g.selectionEnd,d=g.value.substring(e-1,e),d.length>0&&" "!==d&&(b=" "+b),g.value=g.value.substring(0,e)+b+g.value.substring(f,g.value.length),g.focus(),this.$text.scrollTop(h),g.selectionStart=e+b.length,g.selectionEnd=e+b.length):document.selection&&(g.focus(),c=document.selection.createRange(),c.text=b),a.browser.msie&&a.browser.version<=11?this.$text.trigger("keyup"):this.$text.trigger("input"),this},isHintHashtagHidden:function(){return"1"===n.get("_ht-hint")},setHintHashtagHidden:function(){this.isHintHashtagHidden()||(this.$hintHashtag.fadeOut(100),this.$hintHashtag.hasClass("hidden")||this.$hintHashtag.addClass("hidden"))},getTextcompleteDropdown:function(){return this.$text.data("textComplete")&&this.$text.data("textComplete").dropdown.$el},setTextcompeleDropdownPosition:function(b){var c=this.$text.get(0),d=this.$text.textcomplete.getCaretCoordinates(c,c.selectionStart),e=window.parseInt(this.$text.css("lineHeight")),g=this.getTextcompleteDropdown();return d.top+=e,d.top-=this.$text.scrollTop(),b||g.css("visibility","hidden"),this.require("jqueryUiPosition",function(){this.$text.offset().top+d.top+g.outerHeight()>a(window).height()+a(window).scrollTop()&&(d.top=-(g.outerHeight()-d.top+e)),g.position({of:this.$text,my:"left top",at:f.stringFormat("%s+%s %s+%s","left",d.left,"top",d.top)}),g.css("visibility","auto")}.bind(this))},showTextCompeteSuggest:function(){this.$text.textcomplete&&this.$text.textcomplete("trigger")},fixPositionTextcompleteDropdown:function(){var a=this.getTextcompleteDropdown();a&&a.filter(":visible").length&&this.setTextcompeleDropdownPosition(!0)},stopAudioPlay:function(){a(document).trigger("AudioPlayer.stop",{fragment:"publisher"})},onWindowResize:function(){this.$text.textcomplete&&this.getTextcompleteDropdown()&&this.fixPositionTextcompleteDropdown()},onWindowScroll:function(){this.$text.textcomplete&&this.getTextcompleteDropdown()&&this.fixPositionTextcompleteDropdown()},onPhotoUploaderStart:function(b,c){var d=this.photoUploader.getItems();this.photoUploadCounters={all:d.getLength(),done:0,fail:0,remove:0},this.require("photoItem",function(b){var c=this.getElement().find("."+this.cssClasses.resultPhotoList);c.size()||(this.$resultPhotoList=c=a("<div></div>").addClass(this.cssClasses.resultPhotoList).appendTo(this.$resultPhoto)),d.forEach(function(a){var d=new b({model:a});d.render().then(function(a){a.appendTo(c).data("cid",d.model.cid)}.bind(this))}.bind(this))}.bind(this)),this.$resultPhoto.addClass("show")},onPhotoUploaderSuccess:function(a,b){this.photoUploadCounters.done++,this.photoUploaderUpdate()},onPhotoUploaderError:function(a,b){this.photoUploadCounters.fail++,this.photoUploaderUpdate(),this.trigger("errorUploadPhoto")},onPhotoUploaderRemove:function(a,b){b.isUploaded||(this.photoUploadCounters.remove++,this.photoUploaderUpdate())},onAudioUploaderStart:function(b,c){var d=this.audioUploader.getItems();this.audioUploadCounters={all:d.getLength(),done:0,fail:0,remove:0},this.require("audioItem",function(b){var c=this.getElement().find("."+this.cssClasses.resultAudioList);c.size()||(c=a("<div></div>").addClass(this.cssClasses.resultAudioList).appendTo(this.$resultAudio)),d.forEach(function(a){var d=new b({model:a,locales:{error:this.options.locales.errors.audioUploadError}});d.render().then(function(a){a.appendTo(c).data("cid",d.model.cid)}.bind(this))}.bind(this))}.bind(this)),this.$resultAudio.addClass("show")},onAudioUploaderSuccess:function(b,c){var d,e=c.model;d=this.$el.find("."+this.cssClasses.audioItem).filter('[data-id="'+e.get("id")+'"]'),d.size()&&!d.find(".jp__track").size()?this.createAudioPlayList(!0).then(function(a){this.require("audioPlayer",function(b){var c;e.isDestroyed||(c=b.createTrack({id:e.get("id"),name:e.get("name")||this.options.locales.audio.defaultName,author:e.get("author"),url:e.get("url"),uid:e.get("ownerId"),duration:e.get("duration"),ownerDir:e.get("ownerDir"),ownerName:e.get("ownerName"),trackLink:!1,playlist:a}),this.playlist.addTrack(c),d=this.$el.find("."+this.cssClasses.audioItem).filter('[data-id="'+e.get("id")+'"]'),d.removeClass(this.cssClasses.audioItemUploaded).addClass(this.cssClasses.audioItemDone),c.getElement().appendTo(d)),this.audioUploadCounters.done++,this.audioUploaderUpdate()}.bind(this))}.bind(this)):d.each(function(b,c){a(c).find(".jp__track").size()||a(c).remove()})},onAudioUploaderError:function(a,b){var c=this.options.locales.errors[b.error]||this.options.locales.errors.audioUploadError;b.model.set({errorText:c,error:b.error}),this.audioUploadCounters.fail++,this.audioUploaderUpdate(),this.trigger("errorUploadAudio")},onAudioUploaderRemove:function(a,b){b.isUploaded||(this.audioUploadCounters.remove++,this.audioUploaderUpdate())},onPhotoUploadPopupSubmit:function(a,b){var c;c=b.items.map(function(a){return{id:a.get("id"),albumId:a.get("albumId"),ownerId:"user"===b.from||this.options.isGuestBook?m.get("id"):l.get("id"),preview:a.get("filedUrl")?f.filed(a.get("filedUrl"),145,145):a.get("preview")}}.bind(this)),this.multipost.addPhoto(c),this.onChange(),this.render("photo",{items:this.multipost.get("photo")}).then(function(a){this.$resultPhoto.html(a).addClass("show")}.bind(this)),this.trigger("addPhoto",{from:"albums"})},onAudioUploadPopupSubmit:function(a,b){var c;c=b.items.map(function(a){return f.extend(!0,{album_id:a.get("albumId"),owner_id:"user"===b.from||this.options.isGuestBook?m.get("id"):l.get("id")},a.toJSON())}.bind(this)),this.multipost.addAudio(c),this.onChange(),this.render("audio",{items:this.multipost.get("audio")}).then(function(a){this.require("audioPlayer",function(b){this.createAudioPlayList(!0).then(function(c){this.multipost.get("audio").forEach(function(d,e){var f=a.find("."+this.cssClasses.audioItem).eq(e),g=b.createTrack({id:d.id,name:d.name||this.options.locales.audio.defaultName,author:d.author,url:d.url,uid:d.ownerId,duration:d.duration,ownerDir:d.ownerDir,ownerName:d.ownerName,trackLink:!1,playlist:c});c.addTrack(g),g.getElement().appendTo(f),f.addClass(this.cssClasses.audioItemDone)}.bind(this))}.bind(this)),this.$resultAudio.html("").addClass("show"),a.appendTo(this.$resultAudio)}.bind(this))}.bind(this)),this.trigger("addAudio",{from:"albums"})},onVideoUploaderSubmit:function(a){var b=a.items.map(function(b){return{id:b.get("id"),album_id:b.get("albumId"),owner_id:"user"===a.from||this.options.isGuestBook?m.get("id"):l.get("id"),filedUrl:b.get("filedUrl")}}.bind(this));this.multipost.addVideo(b),this.onChange(),this.render("video",{items:this.multipost.get("video")}).then(function(a){this.$resultVideo.html(a).addClass("show")}.bind(this))},hasMedia:function(){return this.multipost.get("photo").length>0||this.multipost.get("audio").length>0||this.multipost.get("video").length>0},onChange:function(){this.$el.removeClass("error");var a=this.hasMedia();this.getText()||a?this.enableSubmit():this.disableSubmit(),this.toggleDisabledStatus(!a)},onSubmitSuccess:function(b){this.$submit.removeClass("progress"),this.stopAudioPlay(),a(document.body).trigger("publisher.newPost",{post:b[3]}),b[4]&&a(document.body).trigger("status.add",b[4]),this.multipost.get("isDelay")&&a(document.body).trigger("delayedPosts.added"),this.trigger("submitSuccess",{multipost:this.multipost.toJSON()}),this.reset()},onSubmitError:function(a){this.$submit.removeClass("progress"),this.trigger("submitError"),a&&a[3]&&"need_verify"===a[3]?this.require("verify",function(a){a.open()}):a&&a[3]&&"ext_url_ratelimit"===a[3]?(this.$externalUrlError.text(this.options.locales.errors.extUrlRatelimit),this.$externalUrl.addClass("error")):this.$el.addClass("error")},onDelayDateTimeChange:function(){var a=this.$delayDate.datepicker("getDate"),b=this.$delayHours.val(),c=this.$delayMinutes.val();a=new Date(a.getTime()+36e5*b+6e4*c),this.multipost.set("delayDate",a)},onSetDelayedPost:function(a,b){this.setDelayDate(new Date(b+36e5))},onTextFocus:function(a,b){this.expand()},onShareTitleInputBlur:function(a,b){this.$share.removeClass(this.cssClasses.shareTitleEdit)},onShareDescriptionInputBlur:function(a,b){this.$share.removeClass(this.cssClasses.shareDescriptionEdit)},onTextInput:function(a,b){var c,d;this.mention&&this.mention.inputReplace(a,b),c=this.getText(),d=c.length+(c.match(/\n/g)||[]).length,this.onChange(),d>=this.options.limit.textWarn?this.$el.addClass(this.cssClasses.limitTextWarn):this.$el.removeClass(this.cssClasses.limitTextWarn),this.multipost&&(this.multipost.set("text",c),this.mention&&(this.multipost.getMentionCount()===this.options.limit.mention?this.$iconMention.addClass("disabled"):this.$iconMention.removeClass("disabled"))),clearTimeout(this.shareCheckTimer),this.shareCheckTimer=setTimeout(function(){this.checkExternalUrls()}.bind(this),this.options.shareCheckDelay),/\B#/.test(c)&&this.setHintHashtagHidden(),this.$textCounter.html(d+" / "+this.options.limit.text),this.toggleDisabledStatus(!this.hasMedia()&&d<this.options.limit.status)},onExternalUrlInput:function(a,b){this.multipost.set("externalUrl",this.$externalUrlInput.val().trim()).validate(),this.multipost.errors.indexOf("invalidExternalUrl")!==-1?(this.$externalUrlError.text(this.options.locales.errors.invalidExternalLink),this.$externalUrl.addClass("error")):this.$externalUrl.removeClass("error")},onControlPhotoClick:function(a,b){b.stopPropagation(),this.photoUploadPopupInited?this.photoUploadPopup.show():(this.require("photoUploadPopup",function(a){this.photoUploadPopup=new a(f.extend(!0,{},this.options.upload.photo,{user:this.options.isGuestBook?m.get("email"):l.get("email"),albumId:this.options.photo.uploaderAlbum,height:this.options.photo.popupHeight,specialAlbums:this.options.isGuestBook?["_guestbook","_animated"]:["_animated"],enableAlbums:!0,enableSelectAlbum:!1,enableAlbumsSourceSwitch:l.get("isCommunity"),hidePrivateAlbums:this.options.isGuestBook})),this.photoUploadPopup.on("submit",this.onPhotoUploadPopupSubmit.bind(this)).show()}.bind(this)),this.photoUploadPopupInited=!0),
this.trigger("controlPhotoClick")},onControlAudioClick:function(a,b){b.stopPropagation(),this.audioUploadPopupInited?this.audioUploadPopup.show():(this.require("audioUploadPopup",function(a){this.audioUploadPopup=new a(f.extend(!0,{},this.options.upload.audio,{user:this.options.isGuestBook?m.get("email"):l.get("email"),height:this.options.audio.popupHeight,enableAlbums:!0,enableAlbumsSourceSwitch:l.get("isCommunity"),isForMultiPost:!0})),this.audioUploadPopup.on("submit",this.onAudioUploadPopupSubmit.bind(this)).show()}.bind(this)),this.audioUploadPopupInited=!0),this.trigger("controlAudioClick")},onControlVideoClick:function(a,b){b.stopPropagation(),this.videoUploaderInited?this.videoUploader.openPopup():(this.require("videoUploadPopup",function(a){this.videoUploader=a.create().onLoad(f.extend(!0,{},this.options.upload.video,{noSendAjaxAddToGroup:!0,startState:"albums",onSelect:this.onVideoUploaderSubmit.bind(this),popupModal:!1,enableSourceSwitch:l.get("isCommunity")&&this.options.journalVideoCount>0,hidePrivateAlbums:this.options.isGuestBook})),this.videoUploader.openPopup()}.bind(this)),this.videoUploaderInited=!0),this.trigger("controlVideoClick")},onControlExternalUrlClick:function(a,b){b.stopPropagation(),this.$externalUrl.toggleClass("show"),this.$externalUrlInput.focus()},onControlStickyClick:function(a,b){b.stopPropagation(),this.toggleSticky()},onControlDelayClick:function(a,b){b.stopPropagation(),this.toggleDelay()},onControlProhibitCommentsClick:function(a,b){b.stopPropagation(),this.toggleProhibitComments()},onSubmitClick:function(a,b){var c=this.multipost.get("photo")||[];try{var d=this.multipost.get("delayDate"),e=d.getTimezoneOffset()/60,f=-3,g=f-e,h=60*g*60*1e3,i=(new Date).getTime()-h,j=d.getTime(),k=i>=j;if(k)return void window.alert(this.options.locales.dateTimeInPast)}catch(a){window.console.error("Failed to check datetime validity: "+a)}b.stopPropagation(),this.$el.removeClass("error"),this.$submit.hasClass("progress")||(this.$submit.addClass("progress"),this.multipost.get("shareUrl")&&this.shareCurrentUrl&&this.multipost.set({text:this.multipost.get("text").replace(this.shareCurrentUrl,"")}),c.forEach(function(a){a.srcUrl&&this.multipost.set("text",this.multipost.get("text").replace(a.srcUrl,""))}.bind(this)),this.multipost.create().then(this.onSubmitSuccess.bind(this),this.onSubmitError.bind(this)),this.trigger("submit",{multipost:this.multipost.toJSON()}))},onPhotoRemoveClick:function(a,b){var c=a.closest("."+this.cssClasses.photoItem),d=String(c.data("id")),e=c.data("cid");b.stopPropagation(),this.removeItem(c,"photo"),this.photoUploader.getItems().getLength()&&(d?(this.photoUploader.getItems().getById(d).trigger("removed"),this.photoUploader.getItems().remove(d)):e&&this.photoUploader.getItems().getByClientId(e).trigger("removed")),this.onChange(),this.trigger("removePhoto")},onAudioRemoveClick:function(a,b){var c=a.closest("."+this.cssClasses.audioItem),d=String(c.data("id")),e=c.data("cid");b.stopPropagation(),this.removeItem(c,"audio"),this.audioUploader.getItems().getLength()&&(d?(this.audioUploader.getItems().getById(d).trigger("removed"),this.audioUploader.getItems().remove(d)):e&&this.audioUploader.getItems().getByClientId(e).trigger("removed")),this.onChange(),this.stopAudioPlay(),this.trigger("removeAudio")},onVideoRemoveClick:function(a,b){var c=a.closest("."+this.cssClasses.videoItem);b.stopPropagation(),this.removeItem(c,"video"),this.onChange(),this.trigger("removeVideo")},onDelayCancelClick:function(a,b){b.stopPropagation(),this.hideDelay()},onShareImageRightClick:function(a,b){b.stopPropagation(),this.shareCurrentImage<this.shareImages.length-1&&(this.shareCurrentImage++,this.showCurrentShareImage()),this.trigger("shareEdit")},onShareImageLeftClick:function(a,b){b.stopPropagation(),this.shareCurrentImage>0&&(this.shareCurrentImage--,this.showCurrentShareImage()),this.trigger("shareEdit")},onShareCancelClick:function(a,b){b.stopPropagation(),this.cancelShare()},onShareTitleEditClick:function(a,b){b.stopPropagation(),this.$share.addClass(this.cssClasses.shareTitleEdit),this.$shareTitleInput.focus()},onShareDescriptionEditClick:function(a,b){b.stopPropagation(),this.$share.addClass(this.cssClasses.shareDescriptionEdit),this.$shareDescriptionInput.focus()},onShareImageRemove:function(a,b){b.stopPropagation(),this.$share.addClass(this.cssClasses.shareWithoutImage),this.multipost.set("shareImage",null)},onControlStatusChange:function(a,b){b&&b.stopPropagation(),this.multipost.set("isStatus",this.$controlStatus.is(":checked"))},toggleDisabledStatus:function(a){this.$controlStatus.attr("disabled",!a),this.$controlStatus.prop("checked",a),this.onControlStatusChange()},onDelayDateChange:function(a,b){this.onDelayDateTimeChange()},onDelayDateHoursChange:function(a,b){this.onDelayDateTimeChange()},onDelayDateMinutesChange:function(a,b){this.onDelayDateTimeChange()},onShareTitleInputChange:function(a,b){var c=this.$shareTitleInput.val().trim();b.stopPropagation(),this.multipost.set("shareTitle",c),this.$share.removeClass(this.cssClasses.shareTitleEdit),this.$shareTitleText.text(c),this.trigger("shareEdit")},onShareDescriptionInputChange:function(a,b){var c=this.$shareDescriptionInput.val().trim();b.stopPropagation(),this.multipost.set("shareDescription",c),this.$share.removeClass(this.cssClasses.shareDescriptionEdit),this.$shareDescriptionText.text(c),this.trigger("shareEdit")},onBodyDragOver:function(a){this.expand().then(function(){setTimeout(function(){this.$el.addClass(this.cssClasses.moveHere)}.bind(this))}.bind(this))},onBodyDragOut:function(a){this.$el.removeClass(this.cssClasses.moveHere)},onBodyDrop:function(a){this.$el.removeClass(this.cssClasses.moveHere),this.$el.removeClass(this.cssClasses.dropHere)},onIconHashtagClick:function(a,b){b.stopPropagation(),this.setHintHashtagHidden(),this.insertToText("#")},onIconMentionClick:function(a,b){b.stopPropagation(),a.hasClass("disabled")||(this.insertToText("@"),this.showTextCompeteSuggest())},onComet:function(a,b){var c;"upload_url"===b.type&&"photo"===b.service&&(c=b.data.item_id,this.multipost&&this.multipost.get("photo").forEach(function(a){String(a.id)===String(c)&&("bad_url"===b.data.result?this.onUploadPhotoByExternalUrlError(a):"ok"===b.data.result&&this.onUploadPhotoByExternalUrlSuccess(a))}.bind(this)),clearTimeout(this.timersCheckTimeout[c]))},onUploadPhotoByExternalUrlSuccess:function(a){var b=this.$el.find("."+this.cssClasses.photoItem).filter('[data-id="'+a.id+'"]');a.status="success",this.multipost.get("photo").forEach(function(b){b.id===a.id&&(b.status="success")}),b.addClass("done").removeClass(this.cssClasses.photoItemError),setTimeout(function(){b.find(".b-publisher__result__photo__item__progress").addClass("hide")},1e3)},onUploadPhotoByExternalUrlError:function(a){var b=this.$el.find("."+this.cssClasses.photoItem).filter('[data-id="'+a.id+'"]');a.status="failed",this.multipost.get("photo").forEach(function(b){b.id===a.id&&(b.status="failed")}),b.addClass(this.cssClasses.photoItemError),b.find(".b-publisher__result__photo__item__progress").addClass("hide")}}});return p});