var __extends=this&&this.__extends||function(){var a=function(b,c){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])})(b,c)};return function(b,c){function d(){this.constructor=b}a(b,c),b.prototype=null===c?Object.create(c):(d.prototype=c.prototype,new d)}}(),__decorate=this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g},__awaiter=this&&this.__awaiter||function(a,b,c,d){function e(a){return a instanceof c?a:new c(function(b){b(a)})}return new(c||(c=Promise))(function(c,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d.throw(a))}catch(a){f(a)}}function i(a){a.done?c(a.value):e(a.value).then(g,h)}i((d=d.apply(a,b||[])).next())})},__generator=this&&this.__generator||function(a,b){function c(a){return function(b){return d([a,b])}}function d(c){if(e)throw new TypeError("Generator is already executing.");for(;i;)try{if(e=1,f&&(g=2&c[0]?f.return:c[0]?f.throw||((g=f.return)&&g.call(f),0):f.next)&&!(g=g.call(f,c[1])).done)return g;switch(f=0,g&&(c=[2&c[0],g.value]),c[0]){case 0:case 1:g=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,f=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(g=i.trys,!(g=g.length>0&&g[g.length-1])&&(6===c[0]||2===c[0])){i=0;continue}if(3===c[0]&&(!g||c[1]>g[0]&&c[1]<g[3])){i.label=c[1];break}if(6===c[0]&&i.label<g[1]){i.label=g[1],g=c;break}if(g&&i.label<g[2]){i.label=g[2],i.ops.push(c);break}g[2]&&i.ops.pop(),i.trys.pop();continue}c=b.call(a,i)}catch(a){c=[6,a],f=0}finally{e=g=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}var e,f,g,h,i={label:0,sent:function(){if(1&g[0])throw g[1];return g[1]},trys:[],ops:[]};return h={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(h[Symbol.iterator]=function(){return this}),h};define(["require","exports","ts/utils","ts/utils","./types","./utils/adapter","./enums","jquery","ts/view"],function(a,b,c,d,e,f,g,h,i){"use strict";var j=function(b){function j(){var a=null!==b&&b.apply(this,arguments)||this;return a.popup=null,a.isAnyPopupOpened=!1,a.popupQueue=[],a}return __extends(j,b),j.prototype.init=function(){return b.prototype.init.call(this),window.app_action_daily_tasks=this.onComet.bind(this),this.initExternalPopupsEventReaction(),this},j.prototype.destroy=function(){return b.prototype.destroy.call(this),delete window.app_action_daily_tasks,this.popup&&(this.popup.destroy(),delete this.popup),h(document).off("popup.show",this.handleOpenAnyPopup),h(document).off("popup.hide",this.handleCloseAnyPopup),this},j.prototype.handleCompleteTaskData=function(a){var b;return __awaiter(this,void 0,void 0,function(){var c,d,e,g,h,i;return __generator(this,function(j){switch(j.label){case 0:return(c=this.options.isShowPopup&&this.getShowPopupConfigFlag(a))?(d=f.getAdaptedTasks(a),(e=!!(null===(b=this.getRecentlyCompletedTasks(d))||void 0===b?void 0:b.length))?(g=this.getMessage(d),h=this.getReward(d),(null===h||void 0===h?void 0:h.value)?(i=this.getAnyPopupOpenStatus(),this.addPopupInQueue({message:g,reward:h}),i?[3,2]:[4,this.executePopupInQueue()]):[3,2]):[3,2]):[3,2];case 1:j.sent(),j.label=2;case 2:return[2]}})})},j.prototype.initExternalPopupsEventReaction=function(){var a=this,b=h(document);this.handleOpenAnyPopup=function(){a.setAnyPopupOpenStatus(!0)},this.handleCloseAnyPopup=function(){return __awaiter(a,void 0,void 0,function(){var a;return __generator(this,function(b){switch(b.label){case 0:return a=this.popupQueue.length,this.setAnyPopupOpenStatus(!1),a?[4,this.executePopupInQueue()]:[3,2];case 1:b.sent(),b.label=2;case 2:return[2]}})})},b.on("popup.show",this.handleOpenAnyPopup),b.on("popup.hide",this.handleCloseAnyPopup)},j.prototype.onComet=function(a){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(b){switch(b.label){case 0:return h(window).trigger(g.EDailyTaskEvent.RECEIVE_COMET,a),[4,this.handleCompleteTaskData(a)];case 1:return b.sent(),[2]}})})},j.prototype.getShowPopupConfigFlag=function(a){var b,c=null===(b=f.getAdaptedConfigs(a.config))||void 0===b?void 0:b.flags;return!c.includes(g.EDailyTaskConfigFlags.HIDE_NOTIFICATIONS)},j.prototype.setAnyPopupOpenStatus=function(a){this.isAnyPopupOpened=a},j.prototype.getAnyPopupOpenStatus=function(){return this.isAnyPopupOpened},j.prototype.getRecentlyCompletedTasks=function(a){return Object.values(a).filter(function(a){return a.gotNewStatus&&a.status===e.ETaskStatusType.DONE})},j.prototype.getReward=function(a){var b=0,c=g.ERewardCurrency.MAILIK;return a.forEach(function(a){var d=a.gotNewStatus,e=a.reward;d&&(b=Number(e[0].value),c=e[0].currency)}),{value:b,currency:c}},j.prototype.getMessage=function(a){var b,c=this,d=null===(b=this.options)||void 0===b?void 0:b.congrats,e=!1,f=!1,h=0,i="",j=function(a){var b,d,e=(null===(d=null===(b=c.options)||void 0===b?void 0:b.locales)||void 0===d?void 0:d.successCongrats)||"",f=function(a){return a.replace(/{a}(.+){a}/gm,'<a class="daily-task-success__link" href="/actions#daily-tasks-block">$1</a>')};i=a.length?f(a):e};if(!d)throw new Error("Отсутствует список оповещений пользователя о выполнении заданий (congrats)");if(a.forEach(function(a){if(a.difficulty===g.EDailyTasksDifficulty.UNIQUE){if(a.isAllow)return e=!!a.status,void(f=a.isAllow)}else a.status&&h++}),e)switch(h){case 0:j(d.done0AndUniq);break;case 1:j(d.done1AndUniq);break;case 2:j(d.done2AndUniq);break;case 3:j(d.done3AndUniq)}else if(f)switch(h){case 1:j(d.done1NoUniq);break;case 2:j(d.done2NoUniq);break;case 3:j(d.done3NoUniq)}else switch(h){case 1:j(d.done1);break;case 2:j(d.done2);break;case 3:j(d.done3)}return i},j.prototype.initPopup=function(b){return __awaiter(this,void 0,void 0,function(){var c,d,e,f,h,i,j,k,l,m=this;return __generator(this,function(n){switch(n.label){case 0:return c=b.message,d=b.reward,e=d.value,f=d.currency,h=void 0===f?g.ERewardCurrency.MAILIK:f,i=this.options.locales,j=this.options.congrats,[4,new Promise(function(b,c){a(["./popups/complete-task-popup"],b,c)})];case 1:return k=n.sent().CompleteTaskPopup,l=function(){return __awaiter(m,void 0,void 0,function(){return __generator(this,function(a){return this.popup=new k({options:this.options,data:{title:j.title||i.couldGetInActions,price:e,currency:h,description:c,buyBtn:i.buy}}),[2]})})},[4,l()];case 2:return n.sent(),[2]}})})},j.prototype.updatePopup=function(a){var b=a.message,c=a.reward,d=c.value,e=c.currency,f=void 0===e?g.ERewardCurrency.MAILIK:e;this.popup.updatePopup({price:d,currency:f,description:b})},j.prototype.showPopup=function(){this.popup&&this.popup.showPopup()},j.prototype.addPopupInQueue=function(a){this.popupQueue.push(a)},j.prototype.executePopupInQueue=function(){var a;return __awaiter(this,void 0,void 0,function(){var b,c,d;return __generator(this,function(e){switch(e.label){case 0:return b=(null===(a=this.popupQueue)||void 0===a?void 0:a.shift())||null,c=this.options.showOnActivePageOnly,d=!c||c&&!document.hidden,b&&d?this.popup?[3,2]:[4,this.initPopup(b)]:[3,4];case 1:return e.sent(),[3,3];case 2:this.popup.hidePopup(),this.updatePopup(b),e.label=3;case 3:this.showPopup(),e.label=4;case 4:return[2]}})})},j=__decorate([d.meta({optionsSelector:".js-daily-tasks-config-complete",css:["daily-tasks"]}),c.extend(i)],j)}(i);return j});