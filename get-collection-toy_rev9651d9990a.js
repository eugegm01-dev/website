define(["jquery","base/view","client-server","util/helpers"],function(a,b,c,d){"use strict";var e=!1,f="collection-toys",g=a(document),h=b.extend({props:{deferred:{popup:"toys-collection/toy-receive-popup"},optionsSelector:"[data-get-collection-toy-config]"},public:{init:function(){window.promoGameEvent=function(){this.checkForToy(!0)}.bind(this),this.onPaymentDialogOpenHandler=this.onPaymentDialogOpen.bind(this),this.onPaymentDialogCloseHandler=this.onPaymentDialogClose.bind(this),g.on("payment-dialog.before-open",this.onPaymentDialogOpenHandler),g.on("payment-dialog.before-close",this.onPaymentDialogCloseHandler),this.checkForToy(!1)},destroy:function(){delete window.promoGameEvent,g.off("payment-dialog.before-open",this.onPaymentDialogOpenHandler),g.off("payment-dialog.before-close",this.onPaymentDialogCloseHandler),delete this.onPaymentDialogOpenHandler,delete this.onPaymentDialogCloseHandler},showPopup:function(a){return e?void(this._delayedShow=function(){this.showPopup(a)}.bind(this)):(a=d.extend({},this.options,a),void(void 0!==this.toyPopup?this.toyPopup.show(a):this.require("popup",function(b){this.toyPopup=new b(a),this.toyPopup.init(),this.toyPopup.show()}.bind(this))))},updateToys:function(){this.checkForToy(!1)}},protected:{onPaymentDialogOpen:function(){e=!0},onPaymentDialogClose:function(){e=!1,"function"==typeof this._delayedShow&&(this._delayedShow(),delete this._delayedShow)},checkForToy:function(a){var b=function(b){this.onFetchInfoSuccess(b,a)}.bind(this);c.func("appanyaction.toyset_user_info",{},{dataType:"json",success:b})},onFetchInfoSuccess:function(a,b){var c,e,f,g=[];try{c=a[3]}catch(a){}d.isObject(c)&&(e=c.toys,Array.isArray(e)&&0!==e.length&&(f=this.getStoredToys(),e.forEach(function(a){if(0!==a.icount){var b=f.filter(function(b){return b.item===a.item})[0];void 0!==b&&a.icount===b.icount||g.push({item:a.item,icount:a.icount-(b?b.icount:0)})}}),b&&0!==g.length&&this.showPopup({toyNumber:g[0].item}),this.setStoredToys(e)))},getStoredToys:function(){var a=[];try{a=JSON.parse(localStorage.getItem(f)||"[]")}catch(a){}return a},setStoredToys:function(a){try{localStorage.setItem(f,JSON.stringify(a))}catch(a){}}}});return h});