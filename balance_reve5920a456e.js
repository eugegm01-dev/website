define(["jquery","base/view","balance/models/balance-model","balance/balance-details","models/user/active"],function(a,b,c,d,e){"use strict";var f=400,g=b.extend({props:{templates:{main:"balance/tmpl/balance"},events:{"click .app-navigation__button_payment":"onPayButtonClick","click .balance__payment-button":"onPayButtonClick"},deferred:{paymentDialog:"payment/payment-dialog"},vars:{mouseLeaveTimer:null,balanceDetails:null,isBalanceDetailsVisible:!1,balanceDetailPopup:null}},public:{init:function(){this.onModelChange=this.onModelChange.bind(this);var a=this.options.enabledBonusUsers,b=this.options.isBonusEnabled&&(0===a.length||a.includes(e.get("email"))),d=b?Number(this.options.bonus)||0:0;return this.isBonusEnabled=b,this.model=new c({balanceWithBonus:Number(this.options.balance)+d,bonus:d,balance:Number(this.options.balance)||0,shouldRefetchOnInit:!0,isBonusEnabled:b}),this.model.on("change",this.onModelChange),this.$placeholderEl=this.$el,this.balanceMouseEnterHandler=this.onBalanceMouseEnter.bind(this),this.balanceMouseLeaveHandler=this.onBalanceMouseLeave.bind(this),this.renderTemplate(),this.isBonusEnabled&&(this.$placeholderEl.on("mouseenter",this.balanceMouseEnterHandler),this.$placeholderEl.on("mouseleave",this.balanceMouseLeaveHandler)),this},renderTemplate:function(){var b=Object.assign({},this.options,{balanceWithBonus:this.model.get("balanceWithBonus"),balance:this.model.get("balance"),bonus:this.isBonusEnabled?this.model.get("bonus"):0,burnNext:this.model.get("burnNext"),isBonusEnabled:this.model.get("isBonusEnabled")}),c=Boolean(this.balanceDetails&&this.balanceDetails.isVisible());this.balanceDetails&&(this.isBalanceDetailsVisible=!1,this.balanceDetails.destroy(),delete this.balanceDetails),this.render(b);try{a(document).find("[data-balance-sum]").html(b.balanceWithBonus).toggleClass("marked",this.model.get("isBonusEnabled")&&0!==b.bonus)}catch(a){console.error("Error while updating banalce value: "+a)}c&&this.onBalanceMouseEnter()},destroy:function(){return this.model.off("change",this.onModelChange),this.model.destroy(),this.$placeholderEl.length&&(this.$placeholderEl.off("mouseenter",this.balanceMouseEnterHandler),delete this.balanceMouseEnterHandler,this.$placeholderEl.off("mouseleave",this.balanceMouseLeaveHandler),delete this.balanceMouseLeaveHandler),this.balanceDetails&&(this.balanceDetails.destroy(),delete this.balanceDetails),g.__super__.destroy.apply(this,arguments),this}},protected:{onBalanceMouseEnter:function(){this.mouseLeaveTimer&&clearTimeout(this.mouseLeaveTimer),this.balanceDetails&&!this.isBalanceDetailsVisible&&(this.balanceDetails.show(),this.isBalanceDetailsVisible=!0)},onBalanceMouseLeave:function(){this.isBalanceDetailsVisible=!1,this.mouseLeaveTimer=setTimeout(function(){this.balanceDetails&&!this.isBalanceDetailsVisible&&this.balanceDetails.hide()}.bind(this),f)},onModelChange:function(){this.renderTemplate()},onPayButtonClick:function(){"function"==typeof this.options.onPayButtonClick?this.options.onPayButtonClick():this.require("paymentDialog",function(a){a.create()}.bind(this))},onRender:function(){var a=Object.assign({},this.options,{balanceWithBonus:this.model.get("balanceWithBonus"),balance:this.model.get("balance"),bonus:this.isBonusEnabled?this.model.get("bonus"):0,burnNext:this.model.get("burnNext"),isBonusEnabled:this.model.get("isBonusEnabled")});this.balanceDetails=d.createRunTime(a,this.$placeholderEl),this.balanceDetails.rendered(function(){this.balanceDetails.$el.hide()}.bind(this))}}});return g});