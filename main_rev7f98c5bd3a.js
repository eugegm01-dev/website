define(["jquery","base/view","util/helpers","util/scroll","util/resize","util/window-visibility","app/banners","isInViewport"],function(a,b,c,d,e,f,g){"use strict";var h={leftColumnBanners:"#leftColumnBanners"},i=1e3,j=b.extend({props:{optionsSelector:".b-additional-banners-config",defaultOptions:{heedLoad:!1,headSelectors:[],moreOffset:0,intervalUpdate:60,scrollHandlerThrottleMs:50},vars:{headOffset:0,firstBannerHeight:0,preventUpdate:null},elements:{container1:".b-additional-banners-block-1",container2:".b-additional-banners-block-2",banners:'[data-mru-fragment="app/banners"]',bottomBanner:".b-additional-banners-2"},events:{mouseleave:"onMouseleave",mouseenter:"onMouseenter","mimic.init .b-additional-banners-block-1":"onMimicInit"}},public:{init:function(){a(document.body).on("togglePopupEvent",this.onTogglePopupEvent.bind(this)),this.options.headSelectors.forEach(function(b){this.headOffset=this.headOffset+a(b).outerHeight()}.bind(this)),this.headOffset=this.headOffset+this.options.moreOffset,this.windowHeight=a(window).height(),this.lastUpdate=0,this.isShownInLeftColumn=Boolean(this.$el.closest(h.leftColumnBanners).length),this.$container1&&(this.firstBannerOffsetTop=this.$container1.offset()&&this.$container1.offset().top||0),this.initBanners();var b=a(window).scrollTop();return b>0&&this.onWindowScroll(null,{scrollTop:b}),this.isShownInLeftColumn?(this.onBoosterLoadedHandler=this.onBoosterLoaded.bind(this),a(document.body).on("booster:loaded",this.onBoosterLoadedHandler)):(this.onWindowResizeHandler=this.onWindowResize.bind(this),e.on(this.onWindowResizeHandler)),this},destroy:function(){if(!this.isShownInLeftColumn)return j.__super__.destroy.call(this),this.stopUpdate(),this.onWindowScrollHandler&&(d.off(this.onWindowScrollHandler),delete this.onWindowScrollHandler),this.onWindowResizeHandler&&(e.off(this.onWindowResizeHandler),delete this.onWindowResizeHandler),this.windowVisibility&&(this.windowVisibility.destroy(),delete this.windowVisibility),this.startUpdateHandler&&(a(window.document).off("show-scroll",this.startUpdateHandler),delete this.startUpdateHandler),this.stopUpdateHandler&&(a(window.document).off("hide-scroll",this.stopUpdateHandler),delete this.stopUpdateHandler),this.updateBannersNowHandler&&(a(window.document).off("additional-banners-update",this.updateBannersNowHandler),delete this.stopUpdateHandler),this.onTogglePopupEvent&&(a(document.body).off("togglePopupEvent",this.onTogglePopupEvent.bind(this)),delete this.onTogglePopupEvent),this}},protected:{onBoosterLoaded:function(){this.updateBanners(),this.startUpdate()},onTogglePopupEvent:function(a){this.preventUpdate=a.isOpen,a.isOpen?this.stopUpdate():this.startUpdate()},onWindowScroll:function(b,c){if(this.isShownInLeftColumn){var d=Boolean(a(h.leftColumnBanners+":in-viewport").length);return d?this.startUpdate():this.stopUpdate()}var e=c.scrollTop;this.isVisible()&&("mimic"===this.fixType?this.windowHeight>700?this.$el.addClass("fixed"):this.$el.removeClass("fixed"):"single"===this.fixType?(0===this.firstBannerHeight&&(this.firstBannerHeight=this.$container1.outerHeight()),!this.$el.hasClass("fixed")&&e+this.headOffset>this.firstBannerHeight+this.firstBannerOffsetTop?(this.$el.addClass("fixed"),this.isBottomBannerInited||(g.createRunTime(this.$banners.filter('[data-num="5018"]')),g.startLoad({scroll:1}).then(function(){this.$bottomBanner.show()}.bind(this)),this.isBottomBannerInited=!0)):this.$el.hasClass("fixed")&&e+this.headOffset<this.firstBannerHeight+this.firstBannerOffsetTop&&this.$el.removeClass("fixed")):this.$el.hasClass("fixed")||this.$el.addClass("fixed"))},onWindowResize:function(){this.windowHeight=a(window).height(),this.isBannersInited?this.isVisible()?(this.startUpdate(),this.updateFixType()):this.stopUpdate():this.initBanners()},onWindowVisibilityChange:function(a,b){this.isVisible()&&(b?this.startUpdate():this.stopUpdate())},onMouseleave:function(){this.startUpdate()},onMouseenter:function(){this.stopUpdate()},onMimicInit:function(){this.isMimic=!0,this.updateFixType()},initBanners:function(){!this.isBannersInited&&this.isVisible()&&(this.isBannersInited=!0,this.options.heedLoad?this.loadBanners():this.updateFixType(),this.startUpdate(),this.windowVisibility=new f,this.windowVisibility.on("visibilityChange",this.onWindowVisibilityChange.bind(this)),this.startUpdateHandler=this.startUpdate.bind(this),this.stopUpdateHandler=this.stopUpdate.bind(this),this.updateBannersNowHandler=this.updateBannersNow.bind(this),this.onWindowScrollHandler=c.throttle(this.onWindowScroll.bind(this),this.options.scrollHandlerThrottleMs),d.on(this.onWindowScrollHandler),this.isShownInLeftColumn&&this.$bottomBanner.show(),a(window.document).on("show-scroll",this.startUpdateHandler),a(window.document).on("hide-scroll",this.stopUpdateHandler),a(window.document).on("additional-banners-update",this.updateBannersNowHandler))},updateFixType:function(){this.isMimic?this.fixType="mimic":this.windowHeight>800||!this.$container2?this.fixType="double":this.fixType="single",this.$el.removeClass("double single").addClass(this.fixType)},startUpdate:function(){!this.updateInterval&&!this.preventUpdate&&this.options&&this.options.intervalUpdate&&(this.updateInterval=setInterval(function(){this.updateBanners()}.bind(this),this.options.intervalUpdate*i))},stopUpdate:function(){this.updateInterval&&(clearInterval(this.updateInterval),delete this.updateInterval)},updateBannersNow:function(){this.stopUpdate(),this.updateBanners(),this.startUpdate()},updateBanners:function(){var b=Date.now(),c=b-this.lastUpdate;c>=this.options.intervalUpdate*i&&(this.$banners.each(function(b,c){return g.createRunTime(a(c)),b}),this.firstBannerHeight=0,this.loadBanners(),this.lastUpdate=b)},loadBanners:function(){g.startLoad({scroll:this.isFixed()?1:0}).then(this.updateFixType.bind(this,!0))},isFixed:function(){return"fixed"===this.$el.css("position")},isVisible:function(){return"none"!==this.$el.css("display")}}});return j});