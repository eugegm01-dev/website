define(["jquery","client-server","base/view","util/helpers","util/promise","util/hosts","app/comet","collections/notifications/alerts"],function(a,b,c,d,e,f,g,h){"use strict";var i=".b-alert",j=a(document.body),k={messages:"dialogues",discussions:"communication"},l=c.extend({singleton:!0,props:{elements:{alerts:i},templates:{commonFriends:"head/tmpl/alerts/common-friends",playlist:"head/tmpl/alerts/playlist"},events:{"click .b-alert":"onAlertOpen",'click [data-action="alert-accept"]':"onAlertAccept",'click [data-action="alert-refuse"]':"onAlertRefuse",'click [data-action="alert-close"]':"onAlertDelete"},deferred:{complaints:"product-tools/complaints","head-buttons":"head/buttons"},optionsSelector:'script[data-type="alert-options"]'},public:{init:function(){var b=a(a(".b-notif-alerts").size()?".b-notif-alerts":".b-head__alerts"),c=JSON.parse(this.$el.html()),e="navigation";this.filters=[],this.setElement(b),this.parseOptions(),this.delegateEvents(),this.options=d.extend({},this.options,c),this.options.view.filters&&(this.filters=String(this.options.view.filters).split(",")),this.options.view.navigation?this.$el.addClass(e):this.$el.removeClass(e),this.onCometEventCallback=this.onCometEvent.bind(this),g.pushEvent.on(this.onCometEventCallback),this.collection=new h;var f=this.$alerts.filter(":visible");return this.$alerts.each(function(b,c){var d=a(c),e=this.collection.addToCollection(d);return this.proccessingAlert(d,e).then(function(){f.length>0&&!d.is(f)?(d.addClass("b-alert_hidden"),d.css("display","")):this.checkFilter(e)?d.show():d.hide()}.bind(this)),b}.bind(this)),this.onTopLayerDestroyHandler=this.onTopLayerDestroy.bind(this),j.on("top-layer-destroy",this.onTopLayerDestroyHandler),this.onTopLayerOpenHandler=this.onTopLayerOpen.bind(this),j.on("top-layer-open",this.onTopLayerOpenHandler),this.onMarketingAlertCloseHandler=function(){this.checkForNextAvailableAlerts()}.bind(this),j.on("marketing-alert-close",this.onMarketingAlertCloseHandler),this},deleteByCategory:function(a,b){var c,d,e,f=0;return c=this.collection.getArrayByAttr("category",a),d=c.length,e=function(){f++,f===d&&"function"==typeof b&&b()},this.collection&&c.forEach(function(a){a.removeElement(e)}),this},addFilter:function(a){return this.filters&&this.filters.push(a),this},removeFilter:function(a){var b=this.filters.indexOf(a);return b!==-1&&this.filters.splice(b,1),this},hide:function(){return this.$el.hide(),this},show:function(){return this.$el.fadeIn(),this},hasActiveAlert:function(){return this.$alerts.filter(":visible").length>0},refreshAlertElements:function(){this.$alerts=this.$el.find(i)},destroy:function(){return this.unDelegateEvents(),this.collection.clear(),this.collection.destroy(),delete this.collection,g.pushEvent.off(this.onCometEventCallback),delete this.onCometEventCallback,delete this.filters,j.off("top-layer-destroy",this.onTopLayerDestroyHandler),delete this.onTopLayerDestroyHandler,j.off("top-layer-open",this.onTopLayerOpenHandler),delete this.onTopLayerOpenHandler,j.off("marketing-alert-close",this.onMarketingAlertCloseHandler),delete this.onMarketingAlertCloseHandler,this}},protected:{onTopLayerDestroy:function(){this.checkForNextAvailableAlerts()},onTopLayerOpen:function(a,b){var c=b.type,d=k[c];void 0===d&&(d=c),this.deleteByCategory(d)},checkFilter:function(a){var b=!0;return this.filters.map(function(c){a.get("type")!==c&&a.get("category")!==c||(b=!1)}),b},addAlert:function(a,b){var c,d,e=this.collection.addToCollection(a);return e&&this.checkFilter(e)&&(this.collection.getArrayByAttr("type",e.get("type")).forEach(function(a){a.get("id")!==e.get("id")&&a.removeElement(0)}),c=e.get("element"),c.hide().appendTo(this.$el),this.refreshAlertElements(),d=this.hasActiveAlert(),d!==!0&&c.fadeIn(),b.isLong||e.setTimeout(),d!==!0&&this.proccessingAlert(c,e)),e},alertAction:function(b,c){return b.set("action",c),this.deleteElement(b),b.save().then(function(b){var c=b[3];c&&c.html&&this.addAlert(a(c.html),c)}.bind(this)),this},getModelByElement:function(a){var b,c;return b=a.is("div.b-alert")?a:a.parents(".b-alert"),c=b.data(),this.collection.getByAttr("alertId",[c.id,c.type].join("-"))},proccessingAlert:function(a,b){var c=["friendship","dialogues"],g=b.get("type");return new e(function(e,h){if(this.options.isGameClient){if(!g.match(/(app|actions)/))return h();a.find("a.b-alert__link").attr("target","_blank"),a.find("a.b-alert__title").attr("target","_top")}a.size()?c.indexOf(g)!==-1?b.fetch().then(function(){var c,g,h=b.get("commonFriends"),i=b.get("playlist"),j=b.get("sender"),k=b.get("user"),l=void 0!==j&&1===Number(j.IsFemale),m=void 0!==k&&1===Number(k.IsFemale);if(h&&d.isArray(h.list)&&h.list.length)this.render("commonFriends",{commonFriends:h.list.map(function(a){return{avatarUrl:a.Avatar32URL+"?"+a.AvatarChangeTime,name:a.Name}}).slice(0,5)}).then(function(b){a.find(".b-alert__common-friends-wrapper__list").html(b),a.find(".b-alert__common-friends-wrapper").show(),a.removeClass("b-alert_hidden"),e()});else if(i){switch(i.covers.cover=i.covers.cover||window.location.protocol+f.getImagesHost()+"music/bg_playlist-default-cover.jpg",c=JSON.parse(a.find(".b-alert__playlist__texts").html()),i.type){case"sender_likes":i.name=i.name||c.playlist+" "+k.Name,g=l?c.senderFemaleLike:c.senderMaleLike;break;case"sender_subscribed":i.name=i.name||c.playlist+" "+k.Name,g=l?c.senderFemaleSubscribe:c.senderMaleSubscribe;break;case"user_likes":i.name=i.name||c.playlist+" "+j.Name,g=m?c.userFemaleLike:c.userMaleLike;break;case"user_subscribed":i.name=i.name||c.playlist+" "+j.Name,g=m?c.userFemaleSubscribe:c.userMaleSubscribe;break;case"both_subscribed":g=c.bothSubscribe}this.render("playlist",{playlist:i,text:g}).then(function(b){a.find(".b-alert__playlist-wrapper").html(b).show(),a.removeClass("b-alert_hidden"),e()})}else a.removeClass("b-alert_hidden"),e()}.bind(this)):(a.removeClass("b-alert_hidden"),e()):e()}.bind(this))},deleteElement:function(a,b){a.removeElement(b)},onAlertOpen:function(b,c){if(!b.hasClass("b-alert_marketing")){var e=this.getModelByElement(b);void 0!==c.target&&void 0!==c.target.href||(this.options.isNewMenu?(a(document.body).trigger("open-head-layer",{from:"alert",type:e.get("category"),options:e.get(["id","type","category","userId","userEmail"]),callbacks:{fail:function(){var a=e.get("href");(d.isUrl(a)||"string"==typeof a&&0===a.indexOf("/"))&&(window.location.href=a)}.bind(this)}}),c.stopPropagation(),this.deleteElement(e)):this.require("head-buttons",function(a){var b=new a,d=b.openAlert(e);d&&(c.stopPropagation(),this.deleteElement(e))}.bind(this)))}},onAlertAccept:function(a,b){var c=this.getModelByElement(a);b.stopPropagation(),this.alertAction(c,"accept")},onAlertRefuse:function(a,b){var c=this.getModelByElement(a);b.stopPropagation(),this.alertAction(c,"refuse")},onAlertDelete:function(b,c){var d,e=this.getModelByElement(b),f=b.data("type")&&!b.hasClass("b-alert__close");c.stopPropagation(),f?this.onAlertOpen(b,c):(d=function(){e.remove().then(function(b){var c=b[3];c&&c.html?this.addAlert(a(c.html),c):this.checkForNextAvailableAlerts()}.bind(this))}.bind(this),this.deleteElement(e,d))},checkForNextAvailableAlerts:function(){var a,b;this.refreshAlertElements(),this.hasActiveAlert()||(a=this.$alerts.filter(":hidden"),a.length>0&&(b=a.first(),this.proccessingAlert(b,this.getModelByElement(b)).then(function(){b.fadeIn()})))},onCometEvent:function(b,c){var d,e;if(b&&!c&&(c=b),"notification-alert"===c.name&&"remove-alert"!==c.data.action){var f=c.data;e=a(c.data.html),e.addClass("b-alert_hidden"),this.addAlert(e,f)}else"remove-alert"!==c.name&&"remove-alert"!==c.data.action||(d=this.collection.getByAttr("eid",c.data.user),d&&d.removeElement())}}});return l});