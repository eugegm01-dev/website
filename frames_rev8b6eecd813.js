define(["jquery","base/view","popup","vip/settings","util/helpers"],function(a,b,c,d,e){"use strict";var f,g=1,h=500;return f=b.extend({props:{elements:{frameName:"[data-avatar-frame-name]"},events:{"click [data-open-frames-popup]":"onPopupOpenerClick"},cssClasses:{popup:"b-popup-2020 b-popup-height-auto",selected:"m-selected",frameImage:"avatar-frame_image-",hasFrame:"m-has-frame"},vars:{isCreatingPopup:!1,selectedFrameID:void 0,savedFrameID:void 0,optionsSelector:"[data-avatar-frames-config]"},templates:{frames:"vip/tmpl/frames"}},public:{init:function(){var b;return this.checkOptions(),this.normalizeFrames(),b=this.options.selectedFrameID||g,this.possibleFrameIDs=this.framesListAll.map(function(a){return parseInt(a.id,10)}),this.selectedFrameID=b,this.savedFrameID=b,this.$framesToChange=a(".avatar.m-is-active-user .avatar-frame"),this.$userAvatarContainer=this.$framesToChange.closest(".avatar-container"),this.checkCurrentFrameID(),this},destroy:function(){return delete this.frames,delete this.framesListAll,delete this.possibleFrameIDs,delete this.selectedFrameID,delete this.savedFrameID,delete this.$framesToChange,delete this.$userAvatarContainer,delete this.$avatarFrames,delete this.$frameItems,this}},protected:{normalizeFrames:function(){function a(a){var d,g,h,i=a.items||[],j=i.slice(),k=a.collections;if(void 0!==k)for(d in k)k.hasOwnProperty(d)&&(g=k[d],i=i.concat(g.items),g.isEnabled!==!1&&(j=j.concat(g.items)));i.forEach(function(a){c.push(a)}),a.isEnabled!==!1&&(j=j.filter(function(a){return a.isEnabled!==!1}),h=e.deepClone(a),h.items=j,delete h.collections,f[b]=h)}var b,c=[],d=e.deepClone(this.options.frames),f={};for(b in d)d.hasOwnProperty(b)&&a(d[b]);this.framesListAll=c,this.frames=f},prepareFramesRenderData:function(){function a(a,b){var c=a.sort||h,d=b.sort||h;return c-d}function b(a){a.items=a.items.slice().map(function(a){var b=a.id;return b===k&&(a.isSelected=!0),0===b?a.avatarHasFrame=0:(a.avatarHasFrame=1,a.avatarFrame=b),a=e.extend({},i,a)}.bind(this)),j.push(a)}var c,d,f=this.options,g=f.locales,i={avatarSize:11,avatarSrc:f.userAvatar,isUserVip:!0,badgeVipSize:6,badgeVipPosition:4,badgeVipHasNoLink:!0,avatarFrameSize:4},j=[],k=this.selectedFrameID;for(c in this.frames)this.frames.hasOwnProperty(c)&&b(e.deepClone(this.frames[c]));return j.sort(a),j.forEach(function(b){b.items.sort(a)}),d={description:g.popup.description,categories:j,isDemo:this.options.isDemo}},checkOptions:function(){var b,c;e.isObject(this.options)&&Object.keys(this.options).length>0||(b=a(this.optionsSelector),c=b.text().trim(),this.options=e.parseJsonFromSrc(c))},checkCurrentFrameID:function(){var a={success:function(a){var b;try{b=parseInt(a.settings.Invismaskno,10)}catch(a){}void 0!==b&&(this.selectedFrameID=b,this.setFrame(b,!0,!0))}.bind(this)};d.getInfo(a)},framesTurnOn:function(){this.$userAvatarContainer.addClass(this.cssClasses.hasFrame)},framesTurnOff:function(){this.$userAvatarContainer.removeClass(this.cssClasses.hasFrame)},onPopupOpenerClick:function(){this.showFramesPopup()},showFramesPopup:function(){var a,b,d,e;this.isCreatingPopup||(this.popup?this.popup.show():(this.isCreatingPopup=!0,a=this.options,e=this.cssClasses,b=a.locales,d=this.prepareFramesRenderData(),this.render("frames",d,function(a){this.popup=c.create({width:500,marginTop:20,rootCssClass:e.popup,isCentered:!0,shouldAdjustScroll:!1,header:b.popup.title,content:a,buttons:[{type:"main",name:"close",text:b.popup.button,callback:function(){this.popup.hide()}.bind(this)}]}),this.popup.on("hide",this.onFramesPopupClose.bind(this)),this.$avatarFrames=a,this.$frameItems=a.find("[data-frame-id]"),this.isCreatingPopup=!1,this.delegateFramesSelectorEvents()}.bind(this))))},onFramesPopupClose:function(){this.setFrame(this.selectedFrameID)},setFrame:function(a,b,c){var e,f,g;a=parseInt(a,10),(b||a!==this.savedFrameID&&void 0!==a)&&(this.savedFrameID=a,f=this.framesListAll.filter(function(b){return b.id===a})[0].name,this.$frameName.text(f),c!==!0&&d.set({frameID:a}),0===a?this.framesTurnOff():(this.framesTurnOn(),e=this.cssClasses.frameImage,g=this.$framesToChange,g.removeClass(function(a,b){var c=b.split(" ").filter(function(a){return a.indexOf(e)!==-1});return c.join(" ")}),g.addClass(this.cssClasses.frameImage+a)))},onFrameItemClick:function(b){var c=a(b.currentTarget),d=this.cssClasses,e=parseInt(c.attr("data-frame-id"),10);this.$frameItems.removeClass(d.selected).filter('[data-frame-id="'+e+'"]').addClass(d.selected),this.selectedFrameID=e},delegateFramesSelectorEvents:function(){void 0!==this.$avatarFrames&&this.$avatarFrames.on("click","[data-frame-id]",this.onFrameItemClick.bind(this))},prepareFrameID:function(a){return(this.possibleFrameIDs||[]).indexOf(a)!==-1?a:void 0}}})});