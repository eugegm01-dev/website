define(["jquery","client-server","counters","base/view","util/lazy-background"],function(a,b,c,d,e){"use strict";return d.extend({props:{events:{"click .js-carousel-prev":"onCarouselPrevClick","click .js-carousel-next":"onCarouselNextClick","click .js-friend-suggest_add":{method:"onFriendSuggestAddClick",throttling:1e3},"click .js-friend-suggest_del":"onFriendSuggestDelClick","transitionend .b-friends-suggests_main_users":"onTransitionEnd"},elements:{carousel:".b-friends-suggests_main_carousel",usersList:".b-friends-suggests_main_users",userItem:".js-friend-suggest_block",usersRight:".b-right-column__block__friends-suggest",carouselPrev:".js-carousel-prev",carouselNext:".js-carousel-next"},selectors:{friendSuggestItem:".js-friend-suggest_block"}},public:{init:function(){this.$carousel.size()&&this.$usersList.size()&&this.initCarousel()}},protected:{onFriendSuggestAddClick:function(a){if(!a.hasClass("progress")&&!a.hasClass("disable")){var c=a.addClass("progress").data(),d={email:c.mail,profile_id:c.id,suggest_reasons:c.suggestType,page:0},e=a.closest(this.selectors.friendSuggestItem);b.func("suggest.add",d,{dataType:"json",cache:!0}).success(function(b){var c=b[3]||"error",d=a.text(),f=this.options.statusText[c];a.removeClass("progress").addClass("disable").text(f),["friendship_offer"].indexOf(c)!==-1?e.delay(1500).queue(function(a){this.removeFriendSuggestItem(e),a()}.bind(this)):a.delay(3e3).queue(function(b){a.removeClass("disable").text(d),b()}.bind(this))}.bind(this))}},onFriendSuggestDelClick:function(a){if(!a.hasClass("disable")){var d=a.addClass("disable").data(),e={email:d.mail,key:d.id,suggest_reasons:d.suggestType,page:0},f=a.closest(this.selectors.friendSuggestItem);this.removeFriendSuggestItem(f),b.func("suggest.del",e,{dataType:"json",cache:!0}),c.myrb(338149)}},removeFriendSuggestItem:function(a){var b=this.$el.find(this.selectors.friendSuggestItem),c=b.size(),d=b.index(a);a.addClass("hidden").delay(300).queue(function(b){var f=1,g="b-right-column__block__friends-suggest--long";if(this.carousel||this.$usersRight.hasClass(g)||(this.$usersRight.addClass(g),f=3),a.remove(),this.carousel){var h=c-d<=this.carousel.step+1,i=this.carousel.itemsCount+this.carousel.offset<=this.carousel.step+1;this.carousel.itemsCount=c-1,1!==c&&i&&h&&this.carouselMoveBy(-1)}1===c&&(this.$el.remove(),this.destroy()),this.sendStatSeeUser(f),e.check(),b()}.bind(this))},initCarousel:function(){var a=this.$carousel.width(),b=this.$el.find(this.selectors.friendSuggestItem),c=b.eq(0),d=c.width(),e=c.outerWidth(!0)-d,f=Math.floor(a/d);this.carousel={offset:0,itemsCount:b.size(),itemWidth:d,itemMargin:e,width:a,step:f},this.$carouselNext.toggleClass("disabled hidden",!(this.carousel.itemsCount>this.carousel.step))},onCarouselPrevClick:function(a){a.hasClass("disabled")||this.carouselMoveBy(this.carousel.step)},onCarouselNextClick:function(a){a.hasClass("disabled")||(this.carouselMoveBy(-this.carousel.step),this.checkLazy())},carouselMoveBy:function(a){var b,c=this.carousel.step-this.carousel.itemsCount;a+=this.carousel.offset,a=Math.min(0,a),a=Math.max(c,a),this.carousel.offset=a,0===a?this.disableCarouselControl(this.$carouselPrev):this.enableCarouselControl(this.$carouselPrev),a===c?this.disableCarouselControl(this.$carouselNext):this.enableCarouselControl(this.$carouselNext),b=0===a?0:a===c?this.carousel.width-this.carousel.itemsCount*(this.carousel.itemWidth+this.carousel.itemMargin)-this.carousel.itemMargin:this.carousel.offset*(this.carousel.itemWidth+this.carousel.itemMargin)+33,this.carouselMoveTo(b)},carouselMoveTo:function(a){a="translateX("+a+"px)",this.$usersList.css({"-webkit-transform":a,"-moz-transform":a,transform:a})},disableCarouselControl:function(a){a.toggleClass("disabled",!0).delay(300).queue(function(b){a.toggleClass("hidden",!0),b()})},enableCarouselControl:function(a){a.toggleClass("hidden",!1).delay(0).queue(function(b){a.toggleClass("disabled",!1),b()})},sendStatSeeUser:function(c){var d=this.$userItem.filter(":not(.js-suggest-show)").filter(function(a){return a<c}).addClass("js-suggest-show"),e=a.map(d,function(b){var c=a(b).data();return{email:c.email,suggest_reasons:c.suggestType&&c.suggestType.toString()}});b.func("suggest.viewport",{users:JSON.stringify(e)})},checkLazy:function(){this.$userItem.find(".b-user-item__avatar").filter(":not(.ui-lazy-visible-background)").filter(function(a){return a<4}).addClass("ui-lazy-background"),e.check()},onTransitionEnd:function(a,b){"transform"===b.originalEvent.propertyName&&this.sendStatSeeUser(3)}}})});