define(["jquery","base/model","client-server","app/comet"],function(a,b,c,d){"use strict";var e="balance.update",f=5,g=5,h=b.extend({props:{balanceUpdateTimeout:null,balanceUpdateRequest:null},public:{init:function(){return this.onComet=this.onComet.bind(this),this.onUpdateBalance=this.onUpdateBalance.bind(this),this.updateBalance=this.updateBalance.bind(this),this.isBonusEnabled=Boolean(this.get("isBonusEnabled")),d.pushEvent.on(this.onComet),a(document).on(e,this.onUpdateBalance),this.get("shouldRefetchOnInit")&&this.scheduleBalanceUpdate(g),this},destroy:function(){a(document).off(e,this.onUpdateBalance),delete this.onUpdateBalance,d.pushEvent.off(this.onComet),delete this.onComet,window.clearTimeout(this.balanceUpdateTimeout),h.__super__.destroy.apply(this,arguments)}},protected:{onUpdateBalance:function(a,b){this.scheduleBalanceUpdate(b||g)},scheduleBalanceUpdate:function(a){this.balanceUpdateTimeout=window.setTimeout(this.updateBalance,1e3*a)},requestBalance:function(){return new Promise(function(a){this.balanceUpdateRequest=c.func("",{},{url:"/+/user/current"}).then(function(b){var c=b.data&&b.data.sumBonusMailiki||0,d=(b.data&&b.data.sumMailiki||0)-c;a({mailiki:d,bonus:c})})}.bind(this))},requestBonusFuture:function(){return new Promise(function(a){this.balanceUpdateRequest=c.func("ttlbonus.records",{},{}).then(function(b){var c=JSON.parse(b),d=c&&c[3]&&c[3].records||[],e=d.reduce(function(a,b){return!a||a>b.ttl?b:a},null),f=e&&e.ttl;if(f){var g=new Date(0);g.setUTCSeconds(f);var h="0"+g.getDate(),i="0"+(g.getMonth()+1),j="0"+g.getHours(),k="0"+g.getMinutes();e.burnTime=h.substr(-2)+"."+i.substr(-2)+" "+j.substr(-2)+":"+k.substr(-2)}a(e)})}.bind(this))},updateBalance:function(){delete this.balanceUpdateTimeout;var a=[this.requestBalance()];this.isBonusEnabled&&a.push(this.requestBonusFuture()),Promise.all(a).then(function(a){var b=a[0],c=a[1],d=b.bonus;this.balanceUpdateRequest=null,this.setBalance({balanceWithBonus:b.mailiki+d,balance:b.mailiki,bonus:d,burnNext:c})}.bind(this))},onComet:function(a,b){a&&!b&&(b=a||{}),"billing"!==b.type&&"bitmailChange"!==b.type||!b.data||(this.balanceUpdateTimeout&&(clearTimeout(this.balanceUpdateTimeout),this.balanceUpdateTimeout=null),this.balanceUpdateRequest&&this.balanceUpdateRequest.abort&&(this.balanceUpdateRequest.abort(),this.balanceUpdateRequest=null),this.scheduleBalanceUpdate(f))},setBalance:function(a){var b=a.balanceWithBonus,c=a.balance,d=this.isBonusEnabled&&a.bonus||0,e=a.burnNext,f={};void 0!==b&&Object.assign(f,{balanceWithBonus:b}),void 0!==c&&Object.assign(f,{balance:c}),void 0!==d&&Object.assign(f,{bonus:d}),void 0!==e&&Object.assign(f,{burnNext:e}),this.set(f)}}});return h});