var __extends=this&&this.__extends||function(){var a=function(b,c){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])})(b,c)};return function(b,c){function d(){this.constructor=b}a(b,c),b.prototype=null===c?Object.create(c):(d.prototype=c.prototype,new d)}}(),__decorate=this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g};define(["require","exports","ts/utils","ts/utils","jquery","purchase-card","payment/payment-dialog","util/date-format","ts/view","client-server","models/user/active","app/comet"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";var m=10,n=function(a){function b(){var b=null!==a&&a.apply(this,arguments)||this;return b.onPaymentClose=function(a,b){(null===b||void 0===b?void 0:b.isPaymentDialogDebugEnabled)&&console.log("[payment dialog] onPaymentClose (subscriptionsWidget)","reloadPageAfterClosePopup: ",b.reloadPageAfterClosePopup),(null===b||void 0===b?void 0:b.reloadPageAfterClosePopup)&&window.location.reload()},b}return __extends(b,a),b.prototype.init=function(){var b=this;return a.prototype.init.call(this),this.balance=Number(e(".balance .balance__text").text()||"0")||0,this.renderSubscriptions(),e("body").hasClass("m-pw-checkout-enabled-balance")||l.pushEvent.on(function(a,c){var d,e=parseInt((null===(d=null===c||void 0===c?void 0:c.data)||void 0===d?void 0:d.balance)||"");e&&e<b.balance&&setTimeout(function(){window.location.reload()},500)}),e(document).on(g.BEFORE_CLOSE_EVENT,this.onPaymentClose),this},b.prototype.destroy=function(){return a.prototype.destroy.call(this),delete this.purchaseCardsPanel,e(document).off(g.BEFORE_CLOSE_EVENT,this.onPaymentClose),this},b.prototype.getDateFromTimeInterval=function(a){var b,c=new Date,d=c.getFullYear(),e=new Date(1e3*a),f=e.getFullYear(),g=f===d?"DD MM":"DD MM YYYY";return e.getMonth()===c.getMonth()&&e.getDate()-c.getDate()===1?null===(b=this.options.locales)||void 0===b?void 0:b.tomorrow:h.dateToString(e,g,null,!0)},b.prototype.renderSubscriptions=function(){var a=this,b=this.options,c=b.subscriptions;this.fetchAdBlockSubscriptionData().then(function(b){var d;a.renderControllers("adv",{description:(null===(d=c[0])||void 0===d?void 0:d.description)||"",date:(null===b||void 0===b?void 0:b.upto)?a.getDateFromTimeInterval(null===b||void 0===b?void 0:b.upto):0})}).catch(function(b){var c;a.renderControllers("adv",{description:(null===(c=a.options.locales)||void 0===c?void 0:c.error)||"",date:0}),console.error("Can't get the subscription adv data: "+b)})},b.prototype.renderControllers=function(a,b){var c=this;this.render("widgetControllersTemplate",b,function(b){var d=c.$el.find("[data-type="+a+"] [data-controller]");d.attr("data-controller",""),d.html(b)})},b.prototype.fetchAdBlockSubscriptionData=function(){return new Promise(function(a,b){j.func("adblock.get",{xemail:k.get("email")}).success(function(b){var c=JSON.parse(b);"ok"===c[1].toLowerCase()&&"ok"===c[2].toLowerCase()&&a(c[3])}).error(b)})},b.prototype.onActionButtonClick=function(a){var b=a.closest("[data-type]"),c=b.data("type");this.openPopup(c)},b.prototype.getPurchaseCardsPanel=function(a){var b=this,c=Object.keys(a).map(function(c){var d,e=a[c];if(e.sum[1])return{type:c,title:e.title,price:e.sum[1],description:e.description||"",buttonText:null===(d=b.options.locales)||void 0===d?void 0:d.buy,paymentData:[m,c]}});return new f({data:c,onPaymentResult:function(){b.renderSubscriptions()},onBuyBtnClick:function(){var a,c=b.options,d=c.subscriptions;b.renderControllers("adv",{description:(null===(a=d[0])||void 0===a?void 0:a.description)||"",isDisabled:!0})}})},b.prototype.openPopup=function(a){var b,c=this,d=this.options.subscriptions,e=(null===(b=null===d||void 0===d?void 0:d.filter(function(b){return b.type===a}))||void 0===b?void 0:b[0])||null,f=e&&(null===e||void 0===e?void 0:e.plans)?this.getPurchaseCardsPanel(null===e||void 0===e?void 0:e.plans):null;null===f||void 0===f?void 0:f.rendered(function(){c.purchaseCardsPopup?(c.purchaseCardsPopup.setContent(f.$content),c.purchaseCardsPopup.show()):c.require("popup",function(a){c.purchaseCardsPopup=a.create({width:"auto",minWidth:0,maxWidth:738,marginTop:20,rootCssClass:c.classes.popup,isCentered:!0,isShowFooter:!1,shouldAdjustScroll:!1,readyCallback:function(){c.purchaseCardsPopup.on("hide",function(){f.destroy()})},header:null===e||void 0===e?void 0:e.label,content:f.$content,contentCssClass:"b-popup__content_gray"})})})},b=__decorate([d.meta({classes:{popup:"b-popup-2020 b-popup-height-auto"},deferred:{popup:"popup"},events:{"click [data-action-btn]:not(.disable)":"onActionButtonClick"},optionsSelector:'[data-type="config"]',templates:{widgetControllersTemplate:"subscriptions/tmpl/widget-controllers"},defaultOptions:{}}),c.extend(i)],b)}(i);return n});