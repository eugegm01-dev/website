define(["jquery","client-server","base/view","util/promise","util/helpers","popup","./vkPayCounter","./PaymentDialog"],function(a,b,c,d,e,f,g,h){"use strict";function i(a,b){var c=Object.assign({},{url:a},b);l?(l.updatePaymentIframe(a),l.showPopup()):l=h.create(c)}function j(){p&&console.log("$(window).on('close-payment-dialog')")}function k(c,d){function e(){t&&t.down()}var f=window.mailru,j=d.status,k="/cgi-bin/app/paymentm?",l=d?d.app_id:"",m=d.service_name||"",q=window.sessionStorage.getItem(h.SESSION_KEY_PURCHASE_TYPE)||h.SESSION_KEY_PURCHASE_TYPE_NULL,r=q===h.SESSION_KEY_PURCHASE_TYPE_TOP_UP,s=q===h.SESSION_KEY_PURCHASE_TYPE_BUY,t=window.winModal?window.winModal.get("paymentDialog"):null;if("success"===j?k+="showsuccess=1":(k+="showfail=1",h.cleanPaymentSession()),k+="&issuer_id="+d.issuer_id+"&service_name="+m.replace(/\*/g,"%2A")+"&hide_close=1",p&&console.log("[payment dialog] onPayment",c,d,k,f),l){var u={paymentType:"buy",action:"success"===j?"payment-success":"payment-error"};e(),"success"===j&&((new Image).src="https://gstat.imgsmail.ru/gstat?comet.paySuccess=1&rnd="+Math.random()),l===h.PRODUCT_APP_ID?(m&&(m.toLowerCase().indexOf("стикер")>-1?u.info="sticker":m.toLowerCase().indexOf("vip")>-1?u.info="vip":m.toLowerCase().indexOf("рекламные")>-1?u.info="adv-subscribe":m.toLowerCase().indexOf("бэйдж")>-1&&(u.info="hilo-badge")),p&&console.log("[payment dialog] process - Покупка услуги: ",u.info,m),i(k,{reloadPageAfterClosePopup:/(hilo-badge)|(adv-subscribe)|(vip)/.test(u.info)})):f&&f.server&&f.app_id===d.app_id&&("success"===j?f.server.events.paymentDialog.onPaymentSuccess({app_id:l,service_name:m||"unknown"}):f.server.events.paymentDialog.onPaymentFail(),u.info="app-item; app-id: "+d.app_id+"; service_name: "+d.service_name,p&&console.log("[payment dialog] process - Покупка в приложении: ",u.info),i(k)),n&&g(u)}else if(r)p&&console.log("[payment dialog] process - Пополнение"),g({action:"open-window",paymentType:"refill"}),e(),i(k);else if(!l&&s&&n&&o){var v=a("#purchase-iframe");p&&console.log("[payment dialog] process - Покупка с доплатой (делаем повторный запрос)");try{if(v.length||t&&t.iframe){var w="";t?w=t.iframe:v.length&&(w=v.attr("src")),w&&b.func("",{},{dataType:"json",success:function(){window.winModal.get("paymentDialog").down(),p&&console.log("[payment dialog] process - Покупка с доплатой (повторный запрос прошёл)")},url:w})}}catch(a){}}h.cleanPaymentSession()}var l,m=a("body"),n=m.hasClass("m-pw-checkout-enabled-balance"),o=m.hasClass("m-pw-checkout-repeated-purchase"),p=m.hasClass("payment-dialog-debug-enabled");a(window).on(h.OPEN_DIALOG,function(a,b){i(b.url)}),a(window).on("payment",k),a(window).on("close-payment-dialog",j),window.onCometPayment=function(b,c,d,e){p&&console.log("[payment-dialog] onCometPayment",b,c,d,e),"WITHDRAWAL_BONUS"!==c&&a(window).trigger("payment",{app_id:b,issuer_id:e,service_name:c,status:d}),a(document).trigger("balance.update")}});