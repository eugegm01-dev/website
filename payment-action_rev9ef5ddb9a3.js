define(["jquery","base/view","payment/payment-dialog","models/user/active"],function(a,b,c,d){"use strict";var e="payment",f="click.payment",g=a(document),h=a(window),i=a("body"),j=b.extend({autoInit:!0,props:{vars:{isPaymentOpened:!1}},public:{init:function(){this.onPaymentOpenHandler=this.onPaymentOpen.bind(this),this.onPaymentCloseHandler=this.onPaymentClose.bind(this),this.onPaymentResultHandler=this.onPaymentResult.bind(this),this.onPaymentActionHandler=this.onPaymentAction.bind(this),this.undelegateCommonEvents(),this.delegateCommonEvents()},destroy:function(){this.undelegateCommonEvents(),delete this.onPaymentOpenHandler,delete this.onPaymentCloseHandler,delete this.onPaymentResultHandler,delete this.onPaymentActionHandler},collections:{items:[],add:function(a){this.items.push(a)},remove:function(a){var b=this.items.indexOf(a);b>=0&&this.items.splice(b,1)}},listeners:{onPaymentOpen:{items:[],add:function(a){this.items.push(a)},remove:function(a){var b=this.items.indexOf(a);b>=0&&this.items.splice(b,1)}},onPaymentClose:{items:[],add:function(a){this.items.push(a)},remove:function(a){var b=this.items.indexOf(a);b>=0&&this.items.splice(b,1)}}}},protected:{delegateCommonEvents:function(){g.on(c.BEFORE_OPEN_EVENT,this.onPaymentOpenHandler),g.on(c.BEFORE_CLOSE_EVENT,this.onPaymentCloseHandler),i.on(f,"[data-payment-action]",this.onPaymentActionHandler)},undelegateCommonEvents:function(){g.off(c.BEFORE_OPEN_EVENT,this.onPaymentOpenHandler),g.off(c.BEFORE_CLOSE_EVENT,this.onPaymentCloseHandler),i.off(f)},onPaymentAction:function(){d.isAuthorized()&&!this.isPaymentOpened&&c.create()},onPaymentOpen:function(){this.isPaymentOpened=!0,this.listeners.onPaymentOpen.items.forEach(function(a){"function"==typeof a&&a()}),h.on(e,this.onPaymentResultHandler)},onPaymentClose:function(a,b){this.isPaymentOpened=!1,this.listeners.onPaymentClose.items.forEach(function(a){"function"==typeof a&&a()}),b&&b.isPaymentDialogDebugEnabled&&console.log("[payment dialog] onPaymentClose (payment-action)","reloadPageAfterClosePopup: ",b.reloadPageAfterClosePopup)},onPaymentResult:function(a,b){"success"===b.status&&this.collections&&this.collections.length&&this.collections.forEach(function(a){"function"==typeof a.refetch&&a.refetch()}),h.off(e,this.onPaymentResultHandler)}}});return new j});