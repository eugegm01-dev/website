var __extends=this&&this.__extends||function(){var a=function(b,c){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])})(b,c)};return function(b,c){function d(){this.constructor=b}a(b,c),b.prototype=null===c?Object.create(c):(d.prototype=c.prototype,new d)}}(),__decorate=this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g},__awaiter=this&&this.__awaiter||function(a,b,c,d){function e(a){return a instanceof c?a:new c(function(b){b(a)})}return new(c||(c=Promise))(function(c,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d.throw(a))}catch(a){f(a)}}function i(a){a.done?c(a.value):e(a.value).then(g,h)}i((d=d.apply(a,b||[])).next())})},__generator=this&&this.__generator||function(a,b){function c(a){return function(b){return d([a,b])}}function d(c){if(e)throw new TypeError("Generator is already executing.");for(;i;)try{if(e=1,f&&(g=2&c[0]?f.return:c[0]?f.throw||((g=f.return)&&g.call(f),0):f.next)&&!(g=g.call(f,c[1])).done)return g;switch(f=0,g&&(c=[2&c[0],g.value]),c[0]){case 0:case 1:g=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,f=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(g=i.trys,!(g=g.length>0&&g[g.length-1])&&(6===c[0]||2===c[0])){i=0;continue}if(3===c[0]&&(!g||c[1]>g[0]&&c[1]<g[3])){i.label=c[1];break}if(6===c[0]&&i.label<g[1]){i.label=g[1],g=c;break}if(g&&i.label<g[2]){i.label=g[2],i.ops.push(c);break}g[2]&&i.ops.pop(),i.trys.pop();continue}c=b.call(a,i)}catch(a){c=[6,a],f=0}finally{e=g=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}var e,f,g,h,i={label:0,sent:function(){if(1&g[0])throw g[1];return g[1]},trys:[],ops:[]};return h={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(h[Symbol.iterator]=function(){return this}),h};define(["require","exports","ts/utils","ts/view","external/cookie","client-server","models/user/active","ts/utils"],function(a,b,c,d,e,f,g,h){"use strict";var i="_game-client",j=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return __extends(b,a),b.prototype.init=function(){var a=this,b=this.options,c=b.isGameClientEnabled,d=b.isActiveEmail,e=b.isMyCreated,h=b.permittedPaths,i=b.list,j=i?new RegExp(""+i.replace(/,/g,"|")):null,k=j&&!!g.get("email").match(j);if(c){if(this.redirectOnNotPermittedPaths(h),k?this.setGameClientCookies():this.getGameClientCookies()&&!k&&this.removeGameClientCookies(),d&&!e){var l=f.magic();new Promise(function(){return __awaiter(a,void 0,void 0,function(){var a;return __generator(this,function(b){switch(b.label){case 0:if(!((null===l||void 0===l?void 0:l.mna)&&(null===l||void 0===l?void 0:l.mnb)))return[3,5];b.label=1;case 1:return b.trys.push([1,3,,4]),[4,this.createMy(l)];case 2:return b.sent(),[3,4];case 3:return a=b.sent(),[3,4];case 4:return[3,5];case 5:return[2]}})})})}}else this.getGameClientCookies()&&this.removeGameClientCookies();return this},b.prototype.redirectOnNotPermittedPaths=function(a){if(null===a||void 0===a?void 0:a.length){var b=location.pathname,c=new RegExp("(/("+(null===a||void 0===a?void 0:a.replace(/,/g,"|"))+")/*(d)*)+"),d=!!b.match(c);d||(location.href=location.origin+"/apps")}},b.prototype.setPendingStatus=function(){this.$gameClientCreateBox.addClass(this.cssClasses.pending)},b.prototype.unsetPendingStatus=function(){this.$gameClientCreateBox.removeClass(this.cssClasses.pending)},b.prototype.createMy=function(a){var b=a.mna,c=a.mnb;return __awaiter(this,void 0,void 0,function(){var a=this;return __generator(this,function(d){switch(d.label){case 0:return this.setPendingStatus(),[4,f.func("welcome.create_my",{mna:b,mnb:c},{type:"POST",success:function(){location.reload()},error:function(b){console.error("Не удалось создать мир: ",b),a.unsetPendingStatus(),a.openErrorPopup()}})];case 1:return[2,d.sent()]}})})},b.prototype.getGameClientCookies=function(){return e.get([i])},b.prototype.setGameClientCookies=function(a){void 0===a&&(a="enabled"),e.set(i,a,{path:"/",domain:".mail.ru",expires:1})},b.prototype.removeGameClientCookies=function(){e.set(i,"",{path:"/",domain:".mail.ru",expires:"Thu, 01 Jan 1970 00:00:00 GMT"})},b.prototype.openErrorPopup=function(){return __awaiter(this,void 0,void 0,function(){var a=this;return __generator(this,function(b){try{this.require("popup",function(b){var c,d,e,f;b.create({rootCssClass:"b-popup-2020",contentCssClass:"b-popup__content_text-only",width:500,header:null===(d=null===(c=a.options)||void 0===c?void 0:c.locales)||void 0===d?void 0:d.errorPopupTittle,isCentered:!0,shouldAdjustScroll:!1,minHeight:"346px",isAutoShow:!0,content:null===(f=null===(e=a.options)||void 0===e?void 0:e.locales)||void 0===f?void 0:f.errorPopupMessage})})}catch(a){console.error("Не удалось открыть попап: ",a)}return[2]})})},b=__decorate([h.meta({deferred:{popup:"popup"},elements:{gameClientCreateBox:".js-game-client-create",gameClientCreateText:".js-game-client-create__text"},cssClasses:{pending:"game-client-create_pending",error:"game-client-create_error"},css:["game-client"],optionsSelector:".js-game-client"}),c.extend(d)],b)}(d);return j});