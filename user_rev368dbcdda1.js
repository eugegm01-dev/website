define(["jquery","counters","factory","util/find-event-target","util/scroll","util/helpers","util/uri","app/history","models/user/active"],function(a,b,c,d,e,f,g,h,i){"use strict";var j={init:function(a){this.$el=a,this.$actions=this.$el.find(".profile__activeLinks"),this.$action=this.$el.find(".profile__activeLinks_button_action"),this.$actionText=this.$action.find(".profile__button-actions-text"),this.config=JSON.parse(a.find('[data-profile="config"]').html().replace(/\r|\n|\t|\s{2,}/g,"")),this.$el.on("click",this.onBrowserEvent.bind(this)),this.config.canEditCover&&this.$el.on("click",'[data-cover-type="edit"], #profileAddLink',this.initCover.bind(this)),this.config.canAddStatus&&this.$el.on("click",'.profile__status-new, .profile__status-delete, [data-type="like"]',this.initStatus.bind(this)),this.$el.on("click",".profile__avatar_settings",this.setAvatar.bind(this)),i.ready(function(){i.isAuthorized()||(this.onScrollHandler=this.onScroll.bind(this),e.on(this.onScrollHandler))}.bind(this)),this.config.showAvatar&&h.page(this.config.avatarUrl,h.SetHashModes.SUPPRESS_EVENT),this.initSuggestRefs()},destroy:function(){this.$el.off(),this.$el=null,this.config=null,this.bubbleFriend&&this.bubbleFriend.destroy(),this.deleteFriend&&this.deleteFriend.destroy(),this.unsubscribeUser&&this.unsubscribeUser.destroy(),this.bubbleComplaint&&this.bubbleComplaint.destroy(),this.complaint&&this.complaint.destroy(),this.subscribeUser&&this.subscribeUser.destroy(),this.onScrollHandler&&e.off(this.onScrollHandler),this.cover&&this.cover!==!0&&(this.cover.destroy(),delete this.cover),this.status&&(this.status.onUnload(),delete this.status)},initSuggestRefs:function(){var a=new g,b=a.param("ref");b&&"suggests"===b&&c("suggest/suggest-show-user",function(b){var c=new b;c.userShow(this.config.MyMailEmail,a.param("suggests_src"))}.bind(this))},onBrowserEvent:function(a){var b,c=d(a,"[data-profile-action]");c&&(b=this.actions()[c.data("profileAction")],b&&b.call(this,c,a))},onScroll:function(){this.firstScrollCounter||(b.myrb(8612138),this.firstScrollCounter=!0)},changeSubscribeState:function(a){a?(this.setState("subscribe"),this.$actionText.html(this.config.buttonActionTexts.subscribed)):(this.setState("unSubscribe"),this.$actionText.html(this.config.buttonActionTexts.unSubscribed),this.config.isFriendshipSend||this.config.isFriends||h.page(this.config.MyMailDir)),this.setTruthState()},setState:function(a){switch(a){case"friends":this.config.isSubscribe=!0,this.config.isFriends=!0,this.$actions.addClass("subscribed friends");break;case"sendFriendship":this.config.isSubscribe=!0,this.config.isFriendshipSend=!0,this.$actions.addClass("subscribed friendshipSend");break;case"subscribe":this.config.isSubscribe=!0,this.$actions.addClass("subscribed");break;case"unSubscribe":this.config.isSubscribe=!1,this.$actions.removeClass("subscribed")}},setTruthState:function(){var a;this.config.isFriends?a=this.config.buttonActionTexts.friends:this.config.isFriendshipSend&&(a=this.config.isSubscribe?this.config.buttonActionTexts.subscribed:this.config.buttonActionTexts.friendshipSend),a&&setTimeout(function(){this.$actionText.html(a)}.bind(this),3e3)},errorState:function(a,b){var c=this.$action.data("profileAction"),d=this.$actionText.html();this.$action.removeClass("progress").removeData("profileAction"),this.$actionText.html(b||this.config.buttonActionTexts.error),setTimeout(function(){this.$action.data("profileAction",c),this.$actionText.html(d)}.bind(this),2e3)},initCover:function(b){var d,e;this.cover||(this.cover=!0,d=a(b.target).addClass("progress"),e=d.closest(".profile__editCover").addClass("progress"),c("profile/cover",function(a){this.cover=a.createRunTime(this.$el.find(".profile__cover")),e.removeClass("progress"),d.removeClass("progress"),this.cover.clickHandler(b)}.bind(this)))},initStatus:function(a){this.status||(this.status=!0,c("profile/status",function(b){this.status=b.create(),this.status.onLoad(this.$el.find(".profile__status_container")),this.status.clickHandler(a)}.bind(this)))},setAvatar:function(a){a.preventDefault(),a.stopPropagation(),this.isSetAvatarThrottled||(this.isSetAvatarThrottled=!0,setTimeout(function(){this.isSetAvatarThrottled=!1}.bind(this),1e3),c("avatar-edit/popup",function(a){this.avatarPopup=new a(f.extend({width:807,height:695},this.config.avatar)),this.avatarPopup.show()}.bind(this)))},actions:function(){return{showBubbleActions:function(a,b){b.preventDefault(),b.stopPropagation(),this.bubbleActions?this.bubbleActions.toggle():c("ui/bubble2",function(b){this.bubbleActions=b.create({target:a,container:this.$actions,content:this.config.bubbleActionsTemplate,addClass:"profile__suggestsBock",position:{my:"left top",at:"left bottom",offset:"0 3"}}),this.bubbleActions.show()}.bind(this))},delFriend:function(a){this.bubbleActions.hide(),c("profile/delete-friend",function(b){this.deleteFriend=b.create(a,this.config)}.bind(this))},subscribe:function(a){var b=a.data("profileSubscribe");this.bubbleActions.hide(),this.subscribeUser?this.subscribeUser.subscribe(b):c("profile/subscribe",function(a){this.subscribeUser=new a({id:this.config.MyMailID,callback:this.changeSubscribeState.bind(this),errorCallback:this.errorState.bind(this)}),this.subscribeUser.init(),this.subscribeUser.subscribe(b)}.bind(this))},showBubbleComplaint:function(a,b){b.preventDefault(),b.stopPropagation(),this.bubbleComplaint?this.bubbleComplaint.toggle():c("ui/bubble2",function(b){this.bubbleComplaint=b.create({target:a,container:this.$el,content:this.config.complaint.template,addClass:"profile__suggestsBock",position:{my:"right top",at:"right bottom",offset:"0 3"}}),this.bubbleComplaint.show()}.bind(this))},complaint:function(a){this.bubbleComplaint.hide(),c("profile/mras",function(b){this.complaint=b.create(a,this.config)}.bind(this))},openAuthPopup:function(a,b){b.preventDefault(),b.stopPropagation(),c("product-tools/auth-form",function(a){a.show()})},addFriend:function(){var a=this.$action.data("email");this.isAddFriendThrottled||(this.isAddFriendThrottled=!0,setTimeout(function(){this.isAddFriendThrottled=!1}.bind(this),1e3),this.$action.addClass("progress"),c("product-tools/friendship",function(b){b.add(a).done(function(a,b){"reset_to_initial"!==a?(this.$action.removeClass("progress ui-button-main profile__activeLinks_button").addClass("ui-button-gray profile__activeLinks_link profile__activeLinks_link_more").data("profileAction","showBubbleActions").removeData("clns"),"added_users"===a||"already_friends_users"===a?(b=b||this.config.buttonActionTexts.friends,this.setState("friends")):this.setState("sendFriendship"),this.$actionText.html(b||this.config.buttonActionTexts.friendshipSend),this.setTruthState()):this.$action.removeClass("progress")}.bind(this)).fail(this.errorState.bind(this))}.bind(this)))},addFriendSuggest:function(a){var b=a.data("email");this.$action.data("email",b),this.bubbleActions.hide(),this.actions().addFriend.call(this)}}}};return{create:function(){var a;return{onLoad:function(b){a=Object.create(j),a.init(b)},onUnload:function(){a.destroy()}}}}});